<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Terminal PRO v10.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; background: #000; color: #fff; height: 100%; overflow: hidden; }
        .up { color: #26a69a !important; }
        .down { color: #ef5350 !important; }
        .neutral { color: #787b86 !important; }
        .app-container { display: flex; flex-direction: column; height: 100vh; height: 100dvh; position: relative; }
        .app-header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: #131722; border-bottom: 1px solid #2a2e39; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
        .tabs-wrapper { position: fixed; top: 52px; left: 0; right: 0; z-index: 99; background: #131722; border-bottom: 1px solid #2a2e39; }
        .tabs-container { display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; display: flex; justify-content: space-around; background: #131722; border-top: 1px solid #2a2e39; padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        .content-wrapper { flex: 1; margin-top: 96px; margin-bottom: 70px; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .content-wrapper-no-tabs { flex: 1; margin-top: 52px; margin-bottom: 70px; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .tab-btn { padding: 12px 16px; font-size: 13px; font-weight: 500; color: #787b86; white-space: nowrap; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { color: #d1d4dc; }
        .tab-btn.active { color: #2962ff; border-bottom-color: #2962ff; }
        .tab-watchlist { background: linear-gradient(135deg, #f7931a 0%, #ff6b00 100%); color: white !important; border-radius: 4px; margin: 8px; padding: 6px 12px !important; font-size: 11px !important; font-weight: 600; display: flex; align-items: center; gap: 6px; border: none; }
        .watchlist-count { background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 10px; font-size: 10px; }
        .section-header { padding: 16px 16px 8px; font-size: 11px; font-weight: 600; color: #787b86; text-transform: uppercase; letter-spacing: 0.5px; background: #000; position: sticky; top: 0; z-index: 5; display: flex; justify-content: space-between; align-items: center; }
        .section-count { font-size: 10px; color: #2962ff; font-weight: 500; }
        .asset-item { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(42, 46, 57, 0.5); transition: background 0.15s; }
        .asset-item:hover { background: #1e222d; }
        .asset-rank { width: 28px; font-size: 11px; font-weight: 600; color: #787b86; flex-shrink: 0; }
        .asset-logo { width: 36px; height: 36px; border-radius: 50%; background: #2a2e39; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; cursor: pointer; }
        .asset-info { flex: 1; min-width: 0; cursor: pointer; }
        .asset-ticker { font-size: 15px; font-weight: 600; color: #fff; }
        .asset-name { font-size: 12px; color: #787b86; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .asset-data { text-align: right; flex-shrink: 0; margin-left: 8px; cursor: pointer; }
        .asset-price { font-size: 15px; font-weight: 600; color: #fff; }
        .asset-change { font-size: 12px; display: flex; justify-content: flex-end; gap: 6px; }
        .favorite-btn { width: 44px; height: 44px; min-width: 44px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; font-size: 20px; transition: transform 0.2s; flex-shrink: 0; margin-left: 4px; border-radius: 50%; touch-action: manipulation; }
        .favorite-btn:hover { background: rgba(247, 147, 26, 0.1); transform: scale(1.1); }
        .favorite-btn.active { color: #f7931a; }
        .favorite-btn:not(.active) { color: #555; }
        @keyframes star-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .favorite-btn.just-added { animation: star-pop 0.3s ease; }
        .ver-mas-btn { display: flex; align-items: center; justify-content: center; padding: 14px; color: #2962ff; font-size: 13px; font-weight: 500; cursor: pointer; border-bottom: 1px solid rgba(42, 46, 57, 0.5); background: rgba(41, 98, 255, 0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 4px 12px; color: #787b86; font-size: 10px; cursor: pointer; border: none; background: none; }
        .nav-item:hover, .nav-item.active { color: #2962ff; }
        .nav-icon { width: 24px; height: 24px; }
        .view { display: none; flex-direction: column; height: 100%; }
        .view.active { display: flex; }
        .reels-container { position: fixed; top: 52px; left: 0; right: 0; bottom: 70px; overflow: hidden; background: #000; }
        .reels-horizontal { display: flex; height: 100%; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .reels-index-column { min-width: 100%; height: 100%; overflow: hidden; }
        .reels-vertical { height: 100%; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .reel-card { height: 100%; width: 100%; display: flex; flex-direction: column; background: #000; position: relative; }
        .reels-index-tabs { position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: center; gap: 6px; padding: 10px 8px; z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%); flex-wrap: wrap; }
        .reels-index-tab { padding: 6px 12px; font-size: 11px; font-weight: 600; color: #787b86; background: rgba(42, 46, 57, 0.5); border-radius: 20px; cursor: pointer; }
        .reels-index-tab.active { color: #fff; background: #2962ff; }
        .reels-index-tab.watchlist-tab { background: rgba(247, 147, 26, 0.3); color: #f7931a; }
        .reels-index-tab.watchlist-tab.active { background: #f7931a; color: #fff; }
        .reels-counter { position: absolute; top: 50px; left: 16px; font-size: 11px; color: #787b86; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 12px; z-index: 10; }
        .reel-header { padding: 55px 16px 10px; background: linear-gradient(to bottom, transparent 0%, #131722 100%); }
        .reel-top-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .reel-ticker-info { flex: 1; }
        .reel-ticker { font-size: 26px; font-weight: 700; }
        .reel-name { font-size: 12px; color: #787b86; margin-top: 2px; }
        .reel-favorite-btn { width: 50px; height: 50px; min-width: 50px; display: flex; align-items: center; justify-content: center; border: none; background: rgba(42, 46, 57, 0.7); border-radius: 50%; cursor: pointer; font-size: 24px; touch-action: manipulation; }
        .reel-favorite-btn.active { background: rgba(247, 147, 26, 0.3); color: #f7931a; }
        .reel-favorite-btn:not(.active) { color: #787b86; }
        .reel-price { font-size: 32px; font-weight: 700; margin-top: 8px; }
        .reel-change-row { display: flex; gap: 12px; margin-top: 4px; font-size: 14px; }
        .reel-badges { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .reel-badge { font-size: 10px; padding: 3px 10px; border-radius: 4px; }
        
        /* SWIPE ZONE - Solo aqu√≠ se detecta el swipe */
        .swipe-zone { flex: 1; display: flex; flex-direction: column; touch-action: none; }
        .reel-chart { flex: 1; background: #131722; min-height: 150px; }
        
        /* CHAT CON PAYWALL - touch-action: auto permite scroll normal */
        .reel-chat { background: #131722; border-top: 1px solid #2a2e39; height: 175px; display: flex; flex-direction: column; flex-shrink: 0; position: relative; touch-action: auto; }
        .chat-header { padding: 6px 12px; font-size: 11px; font-weight: 600; color: #787b86; border-bottom: 1px solid #2a2e39; display: flex; justify-content: space-between; align-items: center; background: rgba(41, 98, 255, 0.05); flex-shrink: 0; }
        .chat-header-left { display: flex; align-items: center; gap: 8px; }
        .chat-live-dot { width: 6px; height: 6px; background: #26a69a; border-radius: 50%; animation: pulse 2s infinite; }
        .chat-online { color: #26a69a; font-weight: 500; }
        .chat-timer { color: #f7931a; font-weight: 600; font-size: 10px; background: rgba(247, 147, 26, 0.15); padding: 2px 8px; border-radius: 10px; }
        .chat-timer.warning { color: #ef5350; background: rgba(239, 83, 80, 0.15); }
        .chat-messages { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 6px 10px; display: flex; flex-direction: column; gap: 4px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain; }
        .chat-messages::-webkit-scrollbar { width: 5px; }
        .chat-messages::-webkit-scrollbar-track { background: rgba(42, 46, 57, 0.3); border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(41, 98, 255, 0.5); border-radius: 3px; }
        .chat-msg { padding: 5px 8px; border-radius: 6px; background: rgba(42, 46, 57, 0.4); animation: msgSlide 0.2s ease-out; word-wrap: break-word; }
        @keyframes msgSlide { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .chat-msg.system { background: rgba(41, 98, 255, 0.15); border-left: 2px solid #2962ff; }
        .chat-msg.alert-up { background: rgba(38, 166, 154, 0.2); border-left: 2px solid #26a69a; }
        .chat-msg.alert-down { background: rgba(239, 83, 80, 0.2); border-left: 2px solid #ef5350; }
        .chat-msg.user-msg { background: rgba(0, 212, 255, 0.15); border-left: 2px solid #00d4ff; margin-left: 12px; }
        .chat-msg-head { display: flex; align-items: center; gap: 5px; margin-bottom: 1px; }
        .chat-msg-user { font-weight: 600; font-size: 10px; }
        .chat-msg-user.sys { color: #2962ff; }
        .chat-msg-user.bot { color: #f7931a; }
        .chat-msg-user.trader { color: #26a69a; }
        .chat-msg-user.you { color: #00d4ff; }
        .chat-msg-badge { font-size: 8px; padding: 1px 4px; border-radius: 3px; font-weight: 600; }
        .badge-bot { background: rgba(247, 147, 26, 0.2); color: #f7931a; }
        .badge-pro { background: rgba(38, 166, 154, 0.2); color: #26a69a; }
        .chat-msg-time { font-size: 9px; color: #787b86; margin-left: auto; }
        .chat-msg-text { color: #d1d4dc; line-height: 1.3; font-size: 11px; }
        .chat-input-box { display: flex; padding: 6px 10px; gap: 6px; border-top: 1px solid #2a2e39; background: #0d1117; flex-shrink: 0; touch-action: auto; }
        .chat-input { flex: 1; background: #2a2e39; border: 1px solid #3a3e49; border-radius: 18px; padding: 8px 14px; color: white; font-size: 16px; outline: none; touch-action: auto; }
        .chat-input:focus { border-color: #2962ff; }
        .chat-input::placeholder { color: #787b86; }
        .chat-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-send { background: #2962ff; border: none; border-radius: 50%; width: 34px; height: 34px; min-width: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; touch-action: manipulation; }
        .chat-send:hover { background: #1e53e4; }
        .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* PAYWALL OVERLAY */
        .chat-paywall { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13, 17, 23, 0.97); backdrop-filter: blur(4px); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 15px; text-align: center; }
        .chat-paywall.active { display: flex; }
        .paywall-icon { font-size: 32px; margin-bottom: 8px; }
        .paywall-title { font-size: 13px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .paywall-desc { font-size: 11px; color: #787b86; margin-bottom: 12px; line-height: 1.4; }
        .paywall-btn-buy { background: linear-gradient(135deg, #f7931a 0%, #ff6b00 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; margin-bottom: 8px; transition: transform 0.2s, box-shadow 0.2s; }
        .paywall-btn-buy:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(247, 147, 26, 0.4); }
        .paywall-btn-skip { background: none; border: none; color: #787b86; font-size: 11px; cursor: pointer; padding: 5px 10px; }
        .paywall-btn-skip:hover { color: #d1d4dc; }
        .paywall-locked { font-size: 10px; color: #ef5350; margin-top: 6px; }
        
        .nav-arrow { position: absolute; z-index: 20; background: rgba(41, 98, 255, 0.3); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; }
        @media (min-width: 769px) { .nav-arrow { display: flex; } }
        .nav-arrow-up { top: 65px; left: 50%; transform: translateX(-50%); }
        .nav-arrow-down { bottom: 195px; left: 50%; transform: translateX(-50%); }
        .nav-arrow-left { left: 10px; top: 50%; transform: translateY(-50%); }
        .nav-arrow-right { right: 10px; top: 50%; transform: translateY(-50%); }
        .empty-watchlist { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #787b86; text-align: center; padding: 40px; }
        .empty-watchlist-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .empty-watchlist-title { font-size: 18px; font-weight: 600; color: #d1d4dc; margin-bottom: 8px; }
        .search-container { padding: 16px; background: #000; }
        .search-input { width: 100%; background: #2a2e39; border: none; border-radius: 8px; padding: 12px 16px; color: white; font-size: 15px; outline: none; }
        .community-post { padding: 16px; border-bottom: 1px solid #2a2e39; }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; background: #2962ff; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .post-user { font-weight: 600; font-size: 14px; }
        .post-time { font-size: 12px; color: #787b86; }
        .post-content { font-size: 14px; line-height: 1.5; color: #d1d4dc; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #2a2e39; }
        .settings-label { font-size: 15px; }
        .settings-value { color: #787b86; font-size: 14px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-live { background: #26a69a; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 2px; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="flex items-center gap-3">
                <svg width="28" height="28" viewBox="0 0 36 36" fill="none"><circle cx="18" cy="18" r="18" fill="#2962FF"/><path d="M10 18L16 24L26 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="font-bold text-lg">Terminal PRO</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="status-dot status-live" id="status-dot"></span>
                <span class="text-xs text-[#26a69a]" id="status-text">LIVE</span>
            </div>
        </header>
        
        <div id="view-home" class="view active">
            <div class="tabs-wrapper">
                <div class="tabs-container">
                    <button class="tab-btn tab-watchlist" onclick="openWatchlistReels()">‚≠ê Watch List <span class="watchlist-count" id="watchlist-count-home">0</span></button>
                    <button class="tab-btn active" onclick="filterTab('all', this)">ALL</button>
                    <button class="tab-btn" onclick="filterTab('dow', this)">DOW 30</button>
                    <button class="tab-btn" onclick="filterTab('nasdaq', this)">NASDAQ 100</button>
                    <button class="tab-btn" onclick="filterTab('sp500', this)">S&P 500</button>
                </div>
            </div>
            <div class="content-wrapper" id="home-content"></div>
        </div>
        
        <div id="view-chart" class="view">
            <div class="reels-container" id="reels-container">
                <div class="reels-index-tabs">
                    <div class="reels-index-tab watchlist-tab" data-index="watchlist" onclick="switchReelIndex('watchlist')">‚≠ê Favoritos</div>
                    <div class="reels-index-tab" data-index="dow" onclick="switchReelIndex('dow')">DOW</div>
                    <div class="reels-index-tab active" data-index="nasdaq" onclick="switchReelIndex('nasdaq')">NASDAQ</div>
                    <div class="reels-index-tab" data-index="sp500" onclick="switchReelIndex('sp500')">S&P 500</div>
                </div>
                <div class="reels-counter" id="reels-counter">1 / 30</div>
                <button class="nav-arrow nav-arrow-up" onclick="navigateReel('up')">‚ñ≤</button>
                <button class="nav-arrow nav-arrow-down" onclick="navigateReel('down')">‚ñº</button>
                <button class="nav-arrow nav-arrow-left" onclick="navigateReel('left')">‚óÄ</button>
                <button class="nav-arrow nav-arrow-right" onclick="navigateReel('right')">‚ñ∂</button>
                <div class="reels-horizontal" id="reels-horizontal">
                    <div class="reels-index-column" data-index="watchlist"><div class="reels-vertical" id="reels-vertical-watchlist"></div></div>
                    <div class="reels-index-column" data-index="dow"><div class="reels-vertical" id="reels-vertical-dow"></div></div>
                    <div class="reels-index-column" data-index="nasdaq"><div class="reels-vertical" id="reels-vertical-nasdaq"></div></div>
                    <div class="reels-index-column" data-index="sp500"><div class="reels-vertical" id="reels-vertical-sp500"></div></div>
                </div>
            </div>
        </div>
        
        <div id="view-search" class="view">
            <div class="content-wrapper-no-tabs">
                <div class="search-container"><input type="text" class="search-input" id="search-input" placeholder="üîç Buscar ticker o empresa..." oninput="handleSearch(this.value)"></div>
                <div id="search-results"><div class="p-4 text-center text-[#787b86]">Busca cualquier activo</div></div>
            </div>
        </div>
        
        <div id="view-community" class="view">
            <div class="tabs-wrapper"><div class="tabs-container"><button class="tab-btn active">üì∞ Tendencias</button><button class="tab-btn">üë• Siguiendo</button><button class="tab-btn">üí° Ideas</button></div></div>
            <div class="content-wrapper" id="community-content"></div>
        </div>
        
        <div id="view-settings" class="view">
            <div class="content-wrapper-no-tabs">
                <div class="section-header">CUENTA</div>
                <div class="settings-item"><span class="settings-label">Usuario</span><span class="settings-value">DonTrading_Pro</span></div>
                <div class="settings-item"><span class="settings-label">Plan</span><span class="settings-value" style="color: #787b86;">Free Trial</span></div>
                <div class="section-header">WATCH LIST</div>
                <div class="settings-item"><span class="settings-label">Favoritos guardados</span><span class="settings-value" id="watchlist-count-settings">0</span></div>
                <div class="settings-item" style="cursor:pointer;color:#ef5350;" onclick="clearWatchlist()"><span class="settings-label">üóëÔ∏è Limpiar Watch List</span><span class="settings-value">‚Üí</span></div>
                <div class="section-header">CONEXI√ìN</div>
                <div class="settings-item"><span class="settings-label">WebSocket</span><span class="settings-value" id="ws-status">Conectando...</span></div>
                <div class="settings-item"><span class="settings-label">Latencia</span><span class="settings-value" id="latency-display">--ms</span></div>
                <div class="section-header">MERCADO</div>
                <div class="settings-item"><span class="settings-label">Estado</span><span class="settings-value" id="market-status">--</span></div>
                <div class="settings-item"><span class="settings-label">Hora NY</span><span class="settings-value" id="ny-time">--</span></div>
            </div>
        </div>
        
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchView('home')" id="nav-home"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Inicio</span></button>
            <button class="nav-item" onclick="switchView('chart')" id="nav-chart"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg><span>Gr√°fico</span></button>
            <button class="nav-item" onclick="switchView('search')" id="nav-search"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg><span>Buscar</span></button>
            <button class="nav-item" onclick="switchView('community')" id="nav-community"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg><span>Noticias</span></button>
            <button class="nav-item" onclick="switchView('settings')" id="nav-settings"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg><span>Ajustes</span></button>
        </nav>
    </div>

    <script>
        var API_KEY = 'Q3I6b14c8HL2l_A7faplgnuMTXekxCUU';
        var socket = null;
        var reconnectAttempts = 0;
        var lastMessageTime = Date.now();
        
        // ==========================================
        // SISTEMA DE PAYWALL DEL CHAT
        // ==========================================
        var FREE_CHAT_TIME = 300;
        var LOCKOUT_TIME = 24 * 60 * 60 * 1000;
        var chatTimers = {};
        var currentActiveTicker = null;
        
        function getChatState(ticker) {
            var stored = localStorage.getItem('chatPW_' + ticker);
            if (stored) {
                var data = JSON.parse(stored);
                if (data.lockedUntil && Date.now() > data.lockedUntil) {
                    localStorage.removeItem('chatPW_' + ticker);
                    return null;
                }
                return data;
            }
            return null;
        }
        
        function saveChatState(ticker, state) {
            localStorage.setItem('chatPW_' + ticker, JSON.stringify(state));
        }
        
        function startChatTimer(ticker) {
            var state = getChatState(ticker);
            if (state && state.lockedUntil && Date.now() < state.lockedUntil) {
                showPaywall(ticker, true, state.lockedUntil);
                return;
            }
            var remaining = FREE_CHAT_TIME;
            if (state && state.remaining > 0) remaining = state.remaining;
            if (!chatTimers[ticker]) chatTimers[ticker] = { remaining: remaining, interval: null };
            if (chatTimers[ticker].interval) clearInterval(chatTimers[ticker].interval);
            chatTimers[ticker].remaining = remaining;
            hidePaywall(ticker);
            updateTimerUI(ticker);
            chatTimers[ticker].interval = setInterval(function() {
                chatTimers[ticker].remaining--;
                updateTimerUI(ticker);
                saveChatState(ticker, { remaining: chatTimers[ticker].remaining });
                if (chatTimers[ticker].remaining <= 0) {
                    clearInterval(chatTimers[ticker].interval);
                    chatTimers[ticker].interval = null;
                    showPaywall(ticker, false, null);
                }
            }, 1000);
        }
        
        function stopChatTimer(ticker) {
            if (chatTimers[ticker] && chatTimers[ticker].interval) {
                clearInterval(chatTimers[ticker].interval);
                chatTimers[ticker].interval = null;
                saveChatState(ticker, { remaining: chatTimers[ticker].remaining });
            }
        }
        
        function updateTimerUI(ticker) {
            var timers = document.querySelectorAll('[data-timer="' + ticker + '"]');
            if (!chatTimers[ticker]) return;
            var mins = Math.floor(chatTimers[ticker].remaining / 60);
            var secs = chatTimers[ticker].remaining % 60;
            var txt = '‚è±Ô∏è ' + mins + ':' + (secs < 10 ? '0' : '') + secs;
            timers.forEach(function(el) {
                el.textContent = txt;
                el.classList.toggle('warning', chatTimers[ticker].remaining <= 60);
            });
        }
        
        function showPaywall(ticker, isLocked, lockedUntil) {
            var pws = document.querySelectorAll('[data-paywall="' + ticker + '"]');
            pws.forEach(function(pw) {
                pw.classList.add('active');
                var title = pw.querySelector('.paywall-title');
                var desc = pw.querySelector('.paywall-desc');
                var buyBtn = pw.querySelector('.paywall-btn-buy');
                var skipBtn = pw.querySelector('.paywall-btn-skip');
                var locked = pw.querySelector('.paywall-locked');
                if (isLocked) {
                    var hrs = Math.ceil((lockedUntil - Date.now()) / (1000 * 60 * 60));
                    title.textContent = 'üîí Chat Bloqueado';
                    desc.textContent = 'Actualiza a PRO para acceso ilimitado';
                    buyBtn.style.display = 'block';
                    skipBtn.style.display = 'none';
                    locked.style.display = 'block';
                    locked.textContent = '‚è∞ Gratis en ~' + hrs + 'h';
                } else {
                    title.textContent = '‚è±Ô∏è Prueba Terminada';
                    desc.textContent = 'Tu acceso de 5 min ha expirado';
                    buyBtn.style.display = 'block';
                    skipBtn.style.display = 'block';
                    locked.style.display = 'none';
                }
            });
            document.querySelectorAll('[data-input="' + ticker + '"]').forEach(function(inp) { inp.disabled = true; });
            document.querySelectorAll('[data-sendbtn="' + ticker + '"]').forEach(function(btn) { btn.disabled = true; });
        }
        
        function hidePaywall(ticker) {
            document.querySelectorAll('[data-paywall="' + ticker + '"]').forEach(function(pw) { pw.classList.remove('active'); });
            document.querySelectorAll('[data-input="' + ticker + '"]').forEach(function(inp) { inp.disabled = false; });
            document.querySelectorAll('[data-sendbtn="' + ticker + '"]').forEach(function(btn) { btn.disabled = false; });
        }
        
        function buyPro(ticker) {
            alert('üéâ ¬°Gracias!\\n\\nEn producci√≥n: pago de $20 USD.\\nDemo: acceso extendido.');
            localStorage.removeItem('chatPW_' + ticker);
            if (chatTimers[ticker]) chatTimers[ticker].remaining = FREE_CHAT_TIME;
            hidePaywall(ticker);
            startChatTimer(ticker);
        }
        
        function skipPro(ticker) {
            var lockedUntil = Date.now() + LOCKOUT_TIME;
            saveChatState(ticker, { remaining: 0, lockedUntil: lockedUntil });
            showPaywall(ticker, true, lockedUntil);
        }
        
        // ==========================================
        // CHAT SYSTEM
        // ==========================================
        var tickerChats = {};
        var chatUsers = [
            { name: 'TraderPro', badge: 'pro' }, { name: 'MarketGuru', badge: 'pro' },
            { name: 'InvestorX', badge: null }, { name: 'StockMaster', badge: 'pro' },
            { name: 'BullRunner', badge: null }, { name: 'TechTrader', badge: 'pro' },
            { name: 'AlphaSeeker', badge: null }, { name: 'DayTrader99', badge: null }
        ];
        var marketComments = {
            bigUp: ['üöÄ ¬°Volando!', 'üìà Rompiendo resistencia!', 'üí™ Fuerza compradora', 'üî• Volumen explosivo'],
            smallUp: ['üëç Buen movimiento', 'üìä Subiendo', '‚úÖ Mantiene tendencia'],
            bigDown: ['‚ö†Ô∏è Ca√≠da fuerte', 'üìâ Presi√≥n vendedora', 'üî¥ Rompi√≥ soporte'],
            smallDown: ['üëÄ Retroceso', 'üìä Correcci√≥n', 'ü§î Pullback'],
            general: ['¬øQu√© opinan?', '¬øAlguien m√°s?', 'Interesante', '¬øTarget?', 'Buen setup', '¬øLargo o corto?']
        };
        
        function getTime() { return new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); }
        
        function initTickerChat(ticker) {
            if (!tickerChats[ticker]) {
                tickerChats[ticker] = [];
                addMsg(ticker, 'system', 'Sistema', 'üí¨ Chat de ' + ticker, null);
                setTimeout(function() { addMsg(ticker, 'bot', 'TradingBot', 'üìä Datos activos', 'bot'); }, 500);
            }
        }
        
        function addMsg(ticker, type, user, text, badge) {
            if (!tickerChats[ticker]) tickerChats[ticker] = [];
            tickerChats[ticker].push({ type: type, user: user, text: text, badge: badge, time: getTime() });
            if (tickerChats[ticker].length > 50) tickerChats[ticker].shift();
            refreshChat(ticker);
        }
        
        function addMarketAlert(ticker, alertType, pct) {
            var msgs = marketComments[alertType];
            if (!msgs) return;
            var u = chatUsers[Math.floor(Math.random() * chatUsers.length)];
            var txt = msgs[Math.floor(Math.random() * msgs.length)];
            if (pct !== null) txt += ' (' + (pct > 0 ? '+' : '') + pct.toFixed(2) + '%)';
            var t = alertType.indexOf('Up') >= 0 ? 'alert-up' : (alertType.indexOf('Down') >= 0 ? 'alert-down' : '');
            addMsg(ticker, t, u.name, txt, u.badge);
        }
        
        function refreshChat(ticker) {
            document.querySelectorAll('[data-chat-ticker="' + ticker + '"]').forEach(function(c) {
                var atBottom = c.scrollHeight - c.scrollTop <= c.clientHeight + 50;
                renderChat(c, ticker);
                if (atBottom) c.scrollTop = c.scrollHeight;
            });
        }
        
        function renderChat(container, ticker) {
            var msgs = tickerChats[ticker] || [];
            var html = '';
            for (var i = 0; i < msgs.length; i++) {
                var m = msgs[i];
                var uc = m.type === 'system' ? 'sys' : (m.type === 'bot' ? 'bot' : (m.user === 'T√∫' ? 'you' : 'trader'));
                var bg = m.badge === 'bot' ? '<span class="chat-msg-badge badge-bot">BOT</span>' : (m.badge === 'pro' ? '<span class="chat-msg-badge badge-pro">PRO</span>' : '');
                html += '<div class="chat-msg ' + (m.type || '') + '"><div class="chat-msg-head"><span class="chat-msg-user ' + uc + '">' + m.user + '</span>' + bg + '<span class="chat-msg-time">' + m.time + '</span></div><div class="chat-msg-text">' + m.text + '</div></div>';
            }
            container.innerHTML = html;
        }
        
        function sendChat(ticker, inp) {
            var txt = inp.value.trim();
            if (!txt) return;
            addMsg(ticker, 'user-msg', 'T√∫', txt, null);
            inp.value = '';
            setTimeout(function() {
                var resps = ['üëç Buen punto', 'De acuerdo', 'ü§î Interesante', 'Gracias!', 'üìä Lo veo igual'];
                var u = chatUsers[Math.floor(Math.random() * chatUsers.length)];
                addMsg(ticker, '', u.name, resps[Math.floor(Math.random() * resps.length)], u.badge);
            }, 1000 + Math.random() * 2000);
        }
        
        function startChatSim() {
            setInterval(function() {
                if (currentView !== 'chart') return;
                var ticker = getTicker(reelsState.currentIndexKey, reelsState.currentAssetIndex[reelsState.currentIndexKey]);
                if (ticker && Math.random() > 0.5) {
                    var u = chatUsers[Math.floor(Math.random() * chatUsers.length)];
                    var txt = marketComments.general[Math.floor(Math.random() * marketComments.general.length)];
                    addMsg(ticker, '', u.name, txt, u.badge);
                }
            }, 12000);
        }
        
        function getTicker(indexKey, idx) {
            if (indexKey === 'watchlist') { var e = getWatchlistEmpresas(); return e[idx] ? e[idx].ticker : null; }
            return INDICES_DATA[indexKey] ? INDICES_DATA[indexKey].empresas[idx].ticker : null;
        }
        
        // WATCHLIST
        var watchlist = JSON.parse(localStorage.getItem('tradingWatchlist') || '[]');
        function saveWatchlist() { localStorage.setItem('tradingWatchlist', JSON.stringify(watchlist)); updateWatchlistCounts(); }
        function toggleFavorite(ticker, event) {
            if (event) { event.preventDefault(); event.stopPropagation(); }
            var idx = watchlist.indexOf(ticker); var added = idx === -1;
            if (idx > -1) watchlist.splice(idx, 1); else watchlist.push(ticker);
            saveWatchlist();
            document.querySelectorAll('[data-ticker="' + ticker + '"]').forEach(function(btn) {
                var isFav = watchlist.indexOf(ticker) > -1;
                btn.classList.toggle('active', isFav);
                if (added) { btn.classList.add('just-added'); setTimeout(function() { btn.classList.remove('just-added'); }, 300); }
                btn.textContent = isFav ? '‚≠ê' : '‚òÜ';
            });
            if (currentView === 'home') renderHomeContent();
            if (currentView === 'chart' && reelsState.currentIndexKey === 'watchlist') { buildWatchlistCards(); updateReelsPosition(); }
        }
        function isFavorite(ticker) { return watchlist.indexOf(ticker) > -1; }
        function updateWatchlistCounts() { var c = watchlist.length; var e1 = document.getElementById('watchlist-count-home'); var e2 = document.getElementById('watchlist-count-settings'); if (e1) e1.textContent = c; if (e2) e2.textContent = c; }
        function clearWatchlist() { if (confirm('¬øEliminar todos los favoritos?')) { watchlist = []; saveWatchlist(); renderHomeContent(); if (currentView === 'chart') { buildWatchlistCards(); updateReelsPosition(); } } }
        function getWatchlistEmpresas() { var arr = []; watchlist.forEach(function(t) { for (var k in INDICES_DATA) { var e = INDICES_DATA[k].empresas.find(function(x) { return x.ticker === t; }); if (e && !arr.find(function(x) { return x.ticker === t; })) { arr.push(Object.assign({}, e, { sourceIndex: k })); break; } } }); return arr; }
        function openWatchlistReels() { reelsState.currentIndexKey = 'watchlist'; reelsState.currentAssetIndex.watchlist = 0; switchView('chart'); }
        
        // INDICES DATA
        var DOW = [
            { ticker: 'UNH', nombre: 'UnitedHealth' }, { ticker: 'GS', nombre: 'Goldman Sachs' }, { ticker: 'MSFT', nombre: 'Microsoft' },
            { ticker: 'HD', nombre: 'Home Depot' }, { ticker: 'CAT', nombre: 'Caterpillar' }, { ticker: 'CRM', nombre: 'Salesforce' },
            { ticker: 'V', nombre: 'Visa' }, { ticker: 'AXP', nombre: 'American Express' }, { ticker: 'MCD', nombre: "McDonald's" },
            { ticker: 'AMGN', nombre: 'Amgen' }, { ticker: 'SHW', nombre: 'Sherwin-Williams' }, { ticker: 'TRV', nombre: 'Travelers' },
            { ticker: 'JPM', nombre: 'JPMorgan Chase' }, { ticker: 'BA', nombre: 'Boeing' }, { ticker: 'IBM', nombre: 'IBM' },
            { ticker: 'AAPL', nombre: 'Apple' }, { ticker: 'AMZN', nombre: 'Amazon' }, { ticker: 'HON', nombre: 'Honeywell' },
            { ticker: 'JNJ', nombre: 'Johnson & Johnson' }, { ticker: 'PG', nombre: 'Procter & Gamble' }, { ticker: 'CVX', nombre: 'Chevron' },
            { ticker: 'MRK', nombre: 'Merck' }, { ticker: 'NKE', nombre: 'Nike' }, { ticker: 'DIS', nombre: 'Walt Disney' },
            { ticker: 'WMT', nombre: 'Walmart' }, { ticker: 'NVDA', nombre: 'NVIDIA' }, { ticker: 'MMM', nombre: '3M' },
            { ticker: 'KO', nombre: 'Coca-Cola' }, { ticker: 'CSCO', nombre: 'Cisco' }, { ticker: 'VZ', nombre: 'Verizon' }
        ];
        var NASDAQ = [
            { ticker: 'AAPL', nombre: 'Apple' }, { ticker: 'NVDA', nombre: 'NVIDIA' }, { ticker: 'MSFT', nombre: 'Microsoft' },
            { ticker: 'AMZN', nombre: 'Amazon' }, { ticker: 'META', nombre: 'Meta' }, { ticker: 'GOOGL', nombre: 'Alphabet A' },
            { ticker: 'GOOG', nombre: 'Alphabet C' }, { ticker: 'TSLA', nombre: 'Tesla' }, { ticker: 'AVGO', nombre: 'Broadcom' },
            { ticker: 'COST', nombre: 'Costco' }, { ticker: 'NFLX', nombre: 'Netflix' }, { ticker: 'AMD', nombre: 'AMD' },
            { ticker: 'PEP', nombre: 'PepsiCo' }, { ticker: 'ADBE', nombre: 'Adobe' }, { ticker: 'CSCO', nombre: 'Cisco' },
            { ticker: 'TMUS', nombre: 'T-Mobile' }, { ticker: 'INTC', nombre: 'Intel' }, { ticker: 'CMCSA', nombre: 'Comcast' },
            { ticker: 'INTU', nombre: 'Intuit' }, { ticker: 'TXN', nombre: 'Texas Instruments' }, { ticker: 'QCOM', nombre: 'Qualcomm' },
            { ticker: 'AMGN', nombre: 'Amgen' }, { ticker: 'AMAT', nombre: 'Applied Materials' }, { ticker: 'ISRG', nombre: 'Intuitive Surgical' },
            { ticker: 'BKNG', nombre: 'Booking' }, { ticker: 'HON', nombre: 'Honeywell' }, { ticker: 'VRTX', nombre: 'Vertex' },
            { ticker: 'LRCX', nombre: 'Lam Research' }, { ticker: 'PANW', nombre: 'Palo Alto' }, { ticker: 'MU', nombre: 'Micron' }
        ];
        var SP500 = [
            { ticker: 'AAPL', nombre: 'Apple' }, { ticker: 'MSFT', nombre: 'Microsoft' }, { ticker: 'NVDA', nombre: 'NVIDIA' },
            { ticker: 'AMZN', nombre: 'Amazon' }, { ticker: 'GOOGL', nombre: 'Alphabet A' }, { ticker: 'META', nombre: 'Meta' },
            { ticker: 'GOOG', nombre: 'Alphabet C' }, { ticker: 'BRK.B', nombre: 'Berkshire B' }, { ticker: 'LLY', nombre: 'Eli Lilly' },
            { ticker: 'TSLA', nombre: 'Tesla' }, { ticker: 'UNH', nombre: 'UnitedHealth' }, { ticker: 'JPM', nombre: 'JPMorgan' },
            { ticker: 'V', nombre: 'Visa' }, { ticker: 'XOM', nombre: 'Exxon Mobil' }, { ticker: 'AVGO', nombre: 'Broadcom' },
            { ticker: 'MA', nombre: 'Mastercard' }, { ticker: 'JNJ', nombre: 'Johnson & Johnson' }, { ticker: 'PG', nombre: 'Procter & Gamble' },
            { ticker: 'HD', nombre: 'Home Depot' }, { ticker: 'COST', nombre: 'Costco' }, { ticker: 'MRK', nombre: 'Merck' },
            { ticker: 'ABBV', nombre: 'AbbVie' }, { ticker: 'CVX', nombre: 'Chevron' }, { ticker: 'CRM', nombre: 'Salesforce' },
            { ticker: 'NFLX', nombre: 'Netflix' }, { ticker: 'AMD', nombre: 'AMD' }, { ticker: 'KO', nombre: 'Coca-Cola' },
            { ticker: 'PEP', nombre: 'PepsiCo' }, { ticker: 'BAC', nombre: 'Bank of America' }, { ticker: 'WMT', nombre: 'Walmart' }
        ];
        var INDICES_DATA = {
            dow: { nombre: 'DOW JONES', total: 30, empresas: DOW.map(function(e) { return Object.assign({}, e, { price: 0, change: 0, changePercent: 0, weight: 0 }); }) },
            nasdaq: { nombre: 'NASDAQ 100', total: 100, empresas: NASDAQ.map(function(e) { return Object.assign({}, e, { price: 0, change: 0, changePercent: 0, weight: 0 }); }) },
            sp500: { nombre: 'S&P 500', total: 500, empresas: SP500.map(function(e) { return Object.assign({}, e, { price: 0, change: 0, changePercent: 0, weight: 0 }); }) }
        };
        var preciosEnTiempoReal = {}, datosHistoricos = {};
        var currentView = 'home', currentFilter = 'all';
        var expandedSections = { dow: false, nasdaq: false, sp500: false };
        var reelsState = { currentIndexKey: 'nasdaq', currentAssetIndex: { watchlist: 0, dow: 0, nasdaq: 0, sp500: 0 }, charts: {}, touchStartX: 0, touchStartY: 0, touchEndX: 0, touchEndY: 0, isSwiping: false, swipeTarget: null };
        var INDEX_ORDER = ['watchlist', 'dow', 'nasdaq', 'sp500'];
        
        function switchView(viewId) {
            if (currentActiveTicker) stopChatTimer(currentActiveTicker);
            document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
            document.getElementById('view-' + viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
            document.getElementById('nav-' + viewId).classList.add('active');
            currentView = viewId;
            if (viewId === 'chart') initReels();
            if (viewId === 'community') renderCommunity();
        }
        function filterTab(filter, btn) {
            currentFilter = filter; expandedSections = { dow: false, nasdaq: false, sp500: false };
            document.querySelectorAll('.tabs-container .tab-btn:not(.tab-watchlist)').forEach(function(t) { t.classList.remove('active'); });
            btn.classList.add('active'); renderHomeContent();
        }
        
        // REELS - FIXED
        function initReels() { buildReelCards(); updateReelsPosition(); setupSwipe(); loadChart(); }
        
        function buildReelCards() {
            buildWatchlistCards();
            ['dow', 'nasdaq', 'sp500'].forEach(function(k) {
                var c = document.getElementById('reels-vertical-' + k);
                var emp = INDICES_DATA[k].empresas;
                c.innerHTML = emp.map(function(e, i) { return buildCard(e, k, i); }).join('');
                emp.forEach(function(e) { initTickerChat(e.ticker); });
            });
        }
        
        function buildWatchlistCards() {
            var c = document.getElementById('reels-vertical-watchlist');
            var emp = getWatchlistEmpresas();
            if (emp.length === 0) {
                c.innerHTML = '<div class="reel-card"><div class="empty-watchlist"><div class="empty-watchlist-icon">‚≠ê</div><div class="empty-watchlist-title">Watch List vac√≠a</div><div class="empty-watchlist-text">Agrega activos tocando ‚òÜ</div></div></div>';
                return;
            }
            c.innerHTML = emp.map(function(e, i) { return buildCard(e, 'watchlist', i); }).join('');
            emp.forEach(function(e) { initTickerChat(e.ticker); });
        }
        
        function buildCard(e, k, i) {
            var pos = e.change >= 0;
            var col = e.change === 0 ? 'neutral' : (pos ? 'up' : 'down');
            var sign = pos && e.change !== 0 ? '+' : '';
            var fav = isFavorite(e.ticker);
            var badges = '';
            if (INDICES_DATA.dow.empresas.some(function(x) { return x.ticker === e.ticker; })) badges += '<span class="reel-badge" style="background:#f7931a22;color:#f7931a;border:1px solid #f7931a44;">DOW</span>';
            if (INDICES_DATA.nasdaq.empresas.some(function(x) { return x.ticker === e.ticker; })) badges += '<span class="reel-badge" style="background:#00d4ff22;color:#00d4ff;border:1px solid #00d4ff44;">NDX</span>';
            if (INDICES_DATA.sp500.empresas.some(function(x) { return x.ticker === e.ticker; })) badges += '<span class="reel-badge" style="background:#26a69a22;color:#26a69a;border:1px solid #26a69a44;">SPX</span>';
            
            return '<div class="reel-card" data-ticker="' + e.ticker + '">' +
                '<div class="reel-header">' +
                    '<div class="reel-top-row">' +
                        '<div class="reel-ticker-info"><div class="reel-ticker">' + e.ticker + '</div><div class="reel-name">' + e.nombre + '</div></div>' +
                        '<button class="reel-favorite-btn ' + (fav ? 'active' : '') + '" data-ticker="' + e.ticker + '" onclick="toggleFavorite(\'' + e.ticker + '\', event)">' + (fav ? '‚≠ê' : '‚òÜ') + '</button>' +
                    '</div>' +
                    '<div class="reel-price ' + col + '">$' + formatPrice(e.price) + '</div>' +
                    '<div class="reel-change-row"><span class="' + col + '">' + sign + e.change.toFixed(2) + '</span><span class="' + col + '">(' + sign + e.changePercent.toFixed(2) + '%)</span></div>' +
                    '<div class="reel-badges">' + badges + '</div>' +
                '</div>' +
                '<div class="swipe-zone" data-swipeable="true">' +
                    '<div class="reel-chart" id="chart-' + k + '-' + i + '"></div>' +
                '</div>' +
                '<div class="reel-chat">' +
                    '<div class="chat-header">' +
                        '<div class="chat-header-left"><div class="chat-live-dot"></div><span>üí¨ ' + e.ticker + '</span></div>' +
                        '<span class="chat-timer" data-timer="' + e.ticker + '">‚è±Ô∏è 5:00</span>' +
                    '</div>' +
                    '<div class="chat-messages" data-chat-ticker="' + e.ticker + '"></div>' +
                    '<div class="chat-input-box">' +
                        '<input type="text" class="chat-input" data-input="' + e.ticker + '" placeholder="Escribe..." onkeypress="if(event.key===\'Enter\')sendChat(\'' + e.ticker + '\',this)">' +
                        '<button class="chat-send" data-sendbtn="' + e.ticker + '" onclick="sendChat(\'' + e.ticker + '\',this.previousElementSibling)"><svg width="14" height="14" fill="white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>' +
                    '</div>' +
                    '<div class="chat-paywall" data-paywall="' + e.ticker + '">' +
                        '<div class="paywall-icon">üîí</div>' +
                        '<div class="paywall-title">‚è±Ô∏è Prueba Terminada</div>' +
                        '<div class="paywall-desc">Acceso de 5 min expirado</div>' +
                        '<button class="paywall-btn-buy" onclick="buyPro(\'' + e.ticker + '\')">‚≠ê PRO - $20 USD</button>' +
                        '<button class="paywall-btn-skip" onclick="skipPro(\'' + e.ticker + '\')">No por ahora</button>' +
                        '<div class="paywall-locked"></div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function updateReelsPosition() {
            var hc = document.getElementById('reels-horizontal');
            var pos = INDEX_ORDER.indexOf(reelsState.currentIndexKey);
            hc.style.transform = 'translateX(-' + (pos * 100) + '%)';
            INDEX_ORDER.forEach(function(k) {
                var vc = document.getElementById('reels-vertical-' + k);
                if (!vc) return;
                var idx = reelsState.currentAssetIndex[k];
                var h = document.querySelector('.reels-container').offsetHeight;
                vc.style.transform = 'translateY(-' + (idx * h) + 'px)';
            });
            document.querySelectorAll('.reels-index-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.index === reelsState.currentIndexKey); });
            var total, curr;
            if (reelsState.currentIndexKey === 'watchlist') { total = getWatchlistEmpresas().length || 0; curr = reelsState.currentAssetIndex.watchlist; }
            else { total = INDICES_DATA[reelsState.currentIndexKey].empresas.length; curr = reelsState.currentAssetIndex[reelsState.currentIndexKey]; }
            document.getElementById('reels-counter').textContent = total > 0 ? (curr + 1) + ' / ' + total : '0 / 0';
            
            var newTicker = getTicker(reelsState.currentIndexKey, curr);
            if (currentActiveTicker && currentActiveTicker !== newTicker) stopChatTimer(currentActiveTicker);
            if (newTicker && newTicker !== currentActiveTicker) {
                currentActiveTicker = newTicker;
                setTimeout(function() { refreshChat(newTicker); startChatTimer(newTicker); }, 150);
            }
        }
        
        // SWIPE MEJORADO - Solo en zona de swipe, no en chat
        function setupSwipe() {
            var c = document.getElementById('reels-container');
            
            c.addEventListener('touchstart', function(e) {
                var target = e.target;
                // Verificar si toc√≥ zona de chat
                var inChat = target.closest('.reel-chat') || target.closest('.chat-messages') || target.closest('.chat-input-box');
                if (inChat) {
                    reelsState.isSwiping = false;
                    return; // No hacer swipe en el chat
                }
                reelsState.touchStartX = e.touches[0].clientX;
                reelsState.touchStartY = e.touches[0].clientY;
                reelsState.touchEndX = reelsState.touchStartX;
                reelsState.touchEndY = reelsState.touchStartY;
                reelsState.isSwiping = true;
            }, { passive: true });
            
            c.addEventListener('touchmove', function(e) {
                if (!reelsState.isSwiping) return;
                reelsState.touchEndX = e.touches[0].clientX;
                reelsState.touchEndY = e.touches[0].clientY;
            }, { passive: true });
            
            c.addEventListener('touchend', function() {
                if (!reelsState.isSwiping) return;
                handleSwipe();
                reelsState.isSwiping = false;
            });
            
            c.addEventListener('wheel', function(e) {
                var inChat = e.target.closest('.chat-messages');
                if (inChat) return; // Permitir scroll normal en chat
                e.preventDefault();
                if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                    if (e.deltaY > 0) navReel('down'); else navReel('up');
                } else {
                    if (e.deltaX > 0) navReel('right'); else navReel('left');
                }
            }, { passive: false });
        }
        
        function handleSwipe() {
            var dx = reelsState.touchEndX - reelsState.touchStartX;
            var dy = reelsState.touchEndY - reelsState.touchStartY;
            if (Math.abs(dx) > Math.abs(dy)) { if (Math.abs(dx) > 50) { if (dx > 0) navReel('left'); else navReel('right'); } }
            else { if (Math.abs(dy) > 50) { if (dy > 0) navReel('up'); else navReel('down'); } }
        }
        
        function navReel(dir) {
            var k = reelsState.currentIndexKey, p = INDEX_ORDER.indexOf(k);
            var len = k === 'watchlist' ? getWatchlistEmpresas().length : INDICES_DATA[k].empresas.length;
            if (len === 0 && (dir === 'up' || dir === 'down')) return;
            var curr = reelsState.currentAssetIndex[k];
            if (dir === 'up') reelsState.currentAssetIndex[k] = curr > 0 ? curr - 1 : len - 1;
            else if (dir === 'down') reelsState.currentAssetIndex[k] = curr < len - 1 ? curr + 1 : 0;
            else if (dir === 'left') reelsState.currentIndexKey = p > 0 ? INDEX_ORDER[p - 1] : INDEX_ORDER[INDEX_ORDER.length - 1];
            else if (dir === 'right') reelsState.currentIndexKey = p < INDEX_ORDER.length - 1 ? INDEX_ORDER[p + 1] : INDEX_ORDER[0];
            if (reelsState.currentIndexKey === 'watchlist') buildWatchlistCards();
            updateReelsPosition(); loadChart();
        }
        
        function switchReelIndex(k) { reelsState.currentIndexKey = k; if (k === 'watchlist') buildWatchlistCards(); updateReelsPosition(); loadChart(); }
        function navigateReel(dir) { navReel(dir); }
        
        // CHART - FIXED: Carga diferida y resize correcto
        function loadChart() {
            var k = reelsState.currentIndexKey, idx = reelsState.currentAssetIndex[k], emp;
            if (k === 'watchlist') { var arr = getWatchlistEmpresas(); if (arr.length === 0) return; emp = arr[idx]; }
            else { emp = INDICES_DATA[k].empresas[idx]; }
            if (!emp) return;
            
            var chartId = 'chart-' + k + '-' + idx;
            var container = document.getElementById(chartId);
            if (!container) return;
            
            // Si ya existe, solo hacer resize
            if (reelsState.charts[chartId]) {
                var c = reelsState.charts[chartId].chart;
                c.applyOptions({ width: container.clientWidth, height: container.clientHeight });
                c.timeScale().fitContent();
                return;
            }
            
            // Esperar a que el contenedor tenga dimensiones
            setTimeout(function() {
                if (container.clientWidth === 0 || container.clientHeight === 0) {
                    setTimeout(function() { loadChart(); }, 100);
                    return;
                }
                
                var chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    layout: { background: { color: '#131722' }, textColor: '#787b86' },
                    grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
                    timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2a2e39' },
                    rightPriceScale: { borderColor: '#2a2e39' },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
                });
                var series = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350' });
                reelsState.charts[chartId] = { chart: chart, series: series };
                
                var ticker = emp.ticker;
                if (ticker.indexOf('.') >= 0) {
                    series.setData([{ time: Date.now() / 1000 - 86400, open: 100, high: 105, low: 95, close: 102 }]);
                    return;
                }
                
                var end = new Date(), start = new Date(); start.setDate(start.getDate() - 5);
                fetch('https://api.polygon.io/v2/aggs/ticker/' + ticker + '/range/5/minute/' + start.toISOString().split('T')[0] + '/' + end.toISOString().split('T')[0] + '?adjusted=true&sort=asc&limit=2000&apiKey=' + API_KEY)
                    .then(function(r) { return r.json(); })
                    .then(function(d) {
                        if (d.results && d.results.length > 0) {
                            series.setData(d.results.map(function(b) { return { time: b.t / 1000, open: b.o, high: b.h, low: b.l, close: b.c }; }));
                            chart.timeScale().fitContent();
                        } else {
                            // Sin datos - mostrar mensaje o datos dummy
                            console.log('No data for', ticker);
                        }
                    })
                    .catch(function(e) { console.error('Chart error:', e); });
                
                // Resize observer
                new ResizeObserver(function() {
                    if (container.clientWidth > 0 && container.clientHeight > 0) {
                        chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
                    }
                }).observe(container);
            }, 50);
        }
        
        function selectAsset(ticker, indiceKey) {
            var emp = INDICES_DATA[indiceKey].empresas, idx = emp.findIndex(function(e) { return e.ticker === ticker; });
            if (idx !== -1) { reelsState.currentIndexKey = indiceKey; reelsState.currentAssetIndex[indiceKey] = idx; switchView('chart'); }
        }
        
        // DATA
        function cargarDatos() {
            updateStatus('loading', 'Cargando...');
            var all = {};
            for (var k in INDICES_DATA) { INDICES_DATA[k].empresas.forEach(function(e) { if (e.ticker.indexOf('.') < 0) all[e.ticker] = true; }); }
            var tickers = Object.keys(all), batch = 50, promises = [];
            for (var i = 0; i < tickers.length; i += batch) {
                var b = tickers.slice(i, i + batch).join(',');
                promises.push(fetch('https://api.polygon.io/v2/snapshot/locale/us/markets/stocks/tickers?tickers=' + b + '&apiKey=' + API_KEY).then(function(r) { return r.json(); }));
            }
            Promise.all(promises).then(function(results) {
                results.forEach(function(d) {
                    if (d.tickers) {
                        d.tickers.forEach(function(t) {
                            var price = (t.day && t.day.c) || (t.prevDay && t.prevDay.c) || 0;
                            var prev = (t.prevDay && t.prevDay.c) || price;
                            preciosEnTiempoReal[t.ticker] = price;
                            datosHistoricos[t.ticker] = { previousClose: prev, change: price - prev, changePercent: prev > 0 ? ((price - prev) / prev) * 100 : 0 };
                        });
                    }
                });
                actualizarEmpresas(); calcularPesos(); renderHomeContent(); updateStatus('live', 'LIVE');
            }).catch(function(e) { console.error(e); updateStatus('offline', 'ERROR'); });
        }
        
        function actualizarEmpresas() {
            for (var k in INDICES_DATA) {
                INDICES_DATA[k].empresas.forEach(function(e) {
                    var p = preciosEnTiempoReal[e.ticker], h = datosHistoricos[e.ticker];
                    if (p) e.price = p; if (h) { e.change = h.change; e.changePercent = h.changePercent; }
                });
            }
        }
        
        function calcularPesos() {
            var dow = INDICES_DATA.dow.empresas, total = dow.reduce(function(s, e) { return s + (e.price || 0); }, 0);
            if (total > 0) dow.forEach(function(e) { e.weight = ((e.price || 0) / total) * 100; });
            dow.sort(function(a, b) { return b.weight - a.weight; });
            ['nasdaq', 'sp500'].forEach(function(k) {
                var emp = INDICES_DATA[k].empresas, tw = 0;
                emp.forEach(function(e, i) { e.weight = Math.pow(0.92, i) * 10; tw += e.weight; });
                emp.forEach(function(e) { e.weight = (e.weight / tw) * 100; });
            });
        }
        
        // WEBSOCKET
        function conectarWS() {
            socket = new WebSocket('wss://socket.polygon.io/stocks');
            socket.onopen = function() { socket.send(JSON.stringify({ action: 'auth', params: API_KEY })); };
            socket.onmessage = function(e) {
                var lat = Date.now() - lastMessageTime; lastMessageTime = Date.now();
                document.getElementById('latency-display').textContent = Math.min(lat, 999) + 'ms';
                JSON.parse(e.data).forEach(function(m) {
                    if (m.ev === 'status' && m.status === 'auth_success') {
                        updateStatus('live', 'LIVE');
                        document.getElementById('ws-status').textContent = 'üü¢ Conectado';
                        document.getElementById('ws-status').style.color = '#26a69a';
                        suscribir();
                    }
                    if (m.ev === 'T') procesarTrade(m);
                });
            };
            socket.onerror = function() { updateStatus('offline', 'ERROR'); document.getElementById('ws-status').textContent = 'üî¥ Error'; };
            socket.onclose = function() { updateStatus('offline', 'OFFLINE'); document.getElementById('ws-status').textContent = 'üî¥ Desconectado'; if (reconnectAttempts < 5) { reconnectAttempts++; setTimeout(conectarWS, 2000 * reconnectAttempts); } };
        }
        
        function suscribir() {
            var all = {};
            for (var k in INDICES_DATA) { INDICES_DATA[k].empresas.forEach(function(e) { if (e.ticker.indexOf('.') < 0) all[e.ticker] = true; }); }
            socket.send(JSON.stringify({ action: 'subscribe', params: Object.keys(all).map(function(t) { return 'T.' + t; }).join(',') }));
        }
        
        function procesarTrade(m) {
            var ticker = m.sym, price = m.p, oldPrice = preciosEnTiempoReal[ticker];
            preciosEnTiempoReal[ticker] = price;
            var h = datosHistoricos[ticker];
            if (h) {
                var oldPct = h.changePercent;
                h.change = price - h.previousClose;
                h.changePercent = h.previousClose > 0 ? ((price - h.previousClose) / h.previousClose) * 100 : 0;
                var diff = h.changePercent - oldPct;
                if (oldPrice && Math.abs(diff) > 0.15) {
                    if (diff > 0.4) addMarketAlert(ticker, 'bigUp', h.changePercent);
                    else if (diff > 0.15) addMarketAlert(ticker, 'smallUp', h.changePercent);
                    else if (diff < -0.4) addMarketAlert(ticker, 'bigDown', h.changePercent);
                    else if (diff < -0.15) addMarketAlert(ticker, 'smallDown', h.changePercent);
                }
            }
            for (var k in INDICES_DATA) {
                var emp = INDICES_DATA[k].empresas.find(function(e) { return e.ticker === ticker; });
                if (emp) { emp.price = price; if (h) { emp.change = h.change; emp.changePercent = h.changePercent; } }
            }
            clearTimeout(window.renderTimeout);
            window.renderTimeout = setTimeout(function() { calcularPesos(); renderHomeContent(); }, 300);
        }
        
        function updateStatus(s, t) {
            document.getElementById('status-dot').className = 'status-dot ' + (s === 'live' ? 'status-live' : '');
            document.getElementById('status-text').textContent = t;
            document.getElementById('status-text').style.color = s === 'live' ? '#26a69a' : '#ef5350';
        }
        
        // RENDER
        function renderHomeContent() {
            var c = document.getElementById('home-content'), html = '';
            var indices = currentFilter === 'all' ? ['dow', 'nasdaq', 'sp500'] : [currentFilter];
            indices.forEach(function(k) {
                var ind = INDICES_DATA[k], emp = ind.empresas, exp = expandedSections[k];
                var show = exp ? emp.length : 10, vis = emp.slice(0, show);
                html += '<div class="section-header"><span>' + ind.nombre + '</span><span class="section-count">' + (exp ? emp.length : '10') + ' / ' + ind.total + '</span></div>';
                vis.forEach(function(e, i) { html += renderItem(e, k, i + 1); });
                if (emp.length > 10) html += '<div class="ver-mas-btn" onclick="toggleSection(\'' + k + '\')">' + (exp ? '‚ñ≤ Ver menos' : '‚ñº Ver m√°s (+' + (emp.length - 10) + ')') + '</div>';
            });
            c.innerHTML = html; updateWatchlistCounts();
        }
        
        function renderItem(e, k, rank) {
            var pos = e.change >= 0, col = e.change === 0 ? 'neutral' : (pos ? 'up' : 'down');
            var sign = pos && e.change !== 0 ? '+' : '', fav = isFavorite(e.ticker);
            return '<div class="asset-item"><div class="asset-rank">#' + rank + '</div><div class="asset-logo" onclick="selectAsset(\'' + e.ticker + '\', \'' + k + '\')">' + getLogo(e.ticker) + '</div><div class="asset-info" onclick="selectAsset(\'' + e.ticker + '\', \'' + k + '\')"><div class="asset-ticker">' + e.ticker + '</div><div class="asset-name">' + e.nombre + '</div></div><div class="asset-data" onclick="selectAsset(\'' + e.ticker + '\', \'' + k + '\')"><div class="asset-price">' + formatPrice(e.price) + '</div><div class="asset-change"><span class="' + col + '">' + sign + e.change.toFixed(2) + '</span><span class="' + col + '">' + sign + e.changePercent.toFixed(2) + '%</span></div></div><button class="favorite-btn ' + (fav ? 'active' : '') + '" data-ticker="' + e.ticker + '" onclick="toggleFavorite(\'' + e.ticker + '\', event)">' + (fav ? '‚≠ê' : '‚òÜ') + '</button></div>';
        }
        
        function toggleSection(k) { expandedSections[k] = !expandedSections[k]; renderHomeContent(); }
        
        function getLogo(t) { 
            var colors = { 'AAPL': '#A2AAAD', 'MSFT': '#00A4EF', 'GOOGL': '#4285F4', 'AMZN': '#FF9900', 'META': '#1877F2', 'NVDA': '#76B900', 'TSLA': '#CC0000', 'JPM': '#0A3D6E', 'V': '#1A1F71', 'HD': '#F96302', 'WMT': '#0071CE', 'KO': '#F40009', 'NKE': '#000', 'DIS': '#113CCF', 'NFLX': '#E50914', 'GS': '#6BA4D5' }; 
            return '<div style="width:100%;height:100%;background:' + (colors[t] || '#2a2e39') + ';display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:10px;font-weight:700;color:white;">' + t.substring(0, 2) + '</div>'; 
        }
        
        function formatPrice(p) { return p ? p.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '--'; }
        
        function handleSearch(q) {
            var c = document.getElementById('search-results');
            if (!q) { c.innerHTML = '<div class="p-4 text-center text-[#787b86]">Busca cualquier activo</div>'; return; }
            var res = [], ql = q.toLowerCase();
            for (var k in INDICES_DATA) { 
                INDICES_DATA[k].empresas.forEach(function(e, i) { 
                    if ((e.ticker.toLowerCase().indexOf(ql) >= 0 || e.nombre.toLowerCase().indexOf(ql) >= 0) && !res.find(function(r) { return r.ticker === e.ticker; })) { 
                        res.push(Object.assign({}, e, { indice: k, rank: i + 1 })); 
                    } 
                }); 
            }
            c.innerHTML = res.length === 0 ? '<div class="p-4 text-center text-[#787b86]">Sin resultados</div>' : res.slice(0, 20).map(function(e) { return renderItem(e, e.indice, e.rank); }).join('');
        }
        
        function renderCommunity() { 
            document.getElementById('community-content').innerHTML = [
                { user: 'TraderPro', avatar: 'TP', time: 'hace 5 min', content: 'üöÄ NVDA rompiendo m√°ximos!' },
                { user: 'MarketWatch', avatar: 'MW', time: 'hace 12 min', content: 'SPX en resistencia.' }
            ].map(function(p) { 
                return '<div class="community-post"><div class="post-header"><div class="post-avatar">' + p.avatar + '</div><div><div class="post-user">' + p.user + '</div><div class="post-time">' + p.time + '</div></div></div><div class="post-content">' + p.content + '</div></div>'; 
            }).join(''); 
        }
        
        function updateMarketStatus() { 
            var now = new Date();
            var ny = new Date(now.toLocaleString("en-US", { timeZone: "America/New_York" })); 
            document.getElementById('ny-time').textContent = ny.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }); 
            var h = ny.getHours(), d = ny.getDay(), status = 'üî¥ Cerrado'; 
            if (d !== 0 && d !== 6) { 
                var mins = h * 60 + ny.getMinutes(); 
                if (mins >= 240 && mins < 570) status = 'üü° Pre-Market'; 
                else if (mins >= 570 && mins < 960) status = 'üü¢ Abierto'; 
                else if (mins >= 960 && mins < 1200) status = 'üîµ After Hours'; 
            } 
            document.getElementById('market-status').textContent = status; 
        }
        
        // INIT
        window.onload = function() {
            updateWatchlistCounts(); updateMarketStatus(); setInterval(updateMarketStatus, 30000);
            for (var k in INDICES_DATA) { INDICES_DATA[k].empresas.forEach(function(e) { initTickerChat(e.ticker); }); }
            startChatSim(); cargarDatos(); conectarWS();
        };
        window.onbeforeunload = function() { if (socket) socket.close(); };
    </script>
</body>
</html>