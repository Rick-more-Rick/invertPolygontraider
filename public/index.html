<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Terminal PRO v6.0 - TradingView Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            background: #000000;
            color: #ffffff;
            height: 100%;
            overflow: hidden;
        }
        
        .up { color: #26a69a !important; }
        .down { color: #ef5350 !important; }
        .neutral { color: #787b86 !important; }
        
        /* ==========================================
           LAYOUT PRINCIPAL - FIXED HEADER Y NAVBAR
           ========================================== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            position: relative;
        }
        
        /* Header FIJO */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: #131722;
            border-bottom: 1px solid #2a2e39;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Tabs FIJOS debajo del header */
        .tabs-wrapper {
            position: fixed;
            top: 52px;
            left: 0;
            right: 0;
            z-index: 99;
            background: #131722;
            border-bottom: 1px solid #2a2e39;
        }
        
        .tabs-container {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tabs-container::-webkit-scrollbar { display: none; }
        
        /* Bottom Navigation FIJO */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-around;
            background: #131722;
            border-top: 1px solid #2a2e39;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }
        
        /* Content Area con padding para header y navbar fijos */
        .content-wrapper {
            flex: 1;
            margin-top: 96px; /* header (52px) + tabs (44px) */
            margin-bottom: 70px; /* navbar height */
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Para vistas sin tabs */
        .content-wrapper-no-tabs {
            flex: 1;
            margin-top: 52px;
            margin-bottom: 70px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* ==========================================
           TABS
           ========================================== */
        .tab-btn {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #787b86;
            white-space: nowrap;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn:hover { color: #d1d4dc; }
        .tab-btn.active { 
            color: #2962ff; 
            border-bottom-color: #2962ff;
        }
        
        .tab-special {
            background: #ef5350;
            color: white !important;
            border-radius: 4px;
            margin: 8px;
            padding: 6px 12px !important;
            font-size: 11px !important;
            font-weight: 600;
        }
        
        /* ==========================================
           SECTION HEADERS
           ========================================== */
        .section-header {
            padding: 16px 16px 8px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #000;
            position: sticky;
            top: 0;
            z-index: 5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-count {
            font-size: 10px;
            color: #2962ff;
            font-weight: 500;
        }
        
        /* ==========================================
           ASSET ITEMS
           ========================================== */
        .asset-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(42, 46, 57, 0.5);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .asset-item:hover { background: #1e222d; }
        .asset-item:active { background: #2a2e39; }
        
        .asset-rank {
            width: 24px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            flex-shrink: 0;
        }
        
        .asset-logo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2a2e39;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-size: 11px;
            font-weight: 700;
            color: #787b86;
            overflow: hidden;
        }
        
        .asset-info {
            flex: 1;
            min-width: 0;
        }
        
        .asset-ticker {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .asset-name {
            font-size: 12px;
            color: #787b86;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .asset-data {
            text-align: right;
            flex-shrink: 0;
            margin-left: 12px;
        }
        
        .asset-price {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .asset-change {
            font-size: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 6px;
        }
        
        /* Ver m√°s button */
        .ver-mas-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px;
            color: #2962ff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 1px solid rgba(42, 46, 57, 0.5);
            background: rgba(41, 98, 255, 0.05);
        }
        
        .ver-mas-btn:hover { background: rgba(41, 98, 255, 0.1); }
        
        /* ==========================================
           NAV ITEMS
           ========================================== */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            color: #787b86;
            font-size: 10px;
            cursor: pointer;
            transition: color 0.2s;
            border: none;
            background: none;
        }
        
        .nav-item:hover, .nav-item.active { color: #2962ff; }
        
        .nav-icon {
            width: 24px;
            height: 24px;
        }
        
        /* ==========================================
           VIEWS
           ========================================== */
        .view {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        
        .view.active {
            display: flex;
        }
        
        /* ==========================================
           CHART VIEW
           ========================================== */
        .chart-header {
            padding: 16px;
            background: #131722;
            border-bottom: 1px solid #2a2e39;
        }
        
        .chart-ticker-large {
            font-size: 24px;
            font-weight: 700;
        }
        
        .chart-name {
            font-size: 13px;
            color: #787b86;
            margin-top: 2px;
        }
        
        .chart-price-large {
            font-size: 32px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .chart-change-row {
            display: flex;
            gap: 12px;
            margin-top: 4px;
            font-size: 14px;
        }
        
        #chart-container {
            flex: 1;
            background: #131722;
            min-height: 250px;
        }
        
        /* ==========================================
           CHAT
           ========================================== */
        .chat-container {
            background: #131722;
            border-top: 1px solid #2a2e39;
            height: 180px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .chat-header {
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #787b86;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .chat-message {
            padding: 6px 0;
            border-bottom: 1px solid rgba(42, 46, 57, 0.3);
        }
        
        .chat-message-user {
            color: #2962ff;
            font-weight: 500;
        }
        
        .chat-message-text {
            color: #d1d4dc;
            margin-top: 2px;
        }
        
        .chat-message-time {
            color: #787b86;
            font-size: 10px;
        }
        
        .chat-input-container {
            display: flex;
            padding: 8px 16px;
            gap: 8px;
            border-top: 1px solid #2a2e39;
            flex-shrink: 0;
        }
        
        .chat-input {
            flex: 1;
            background: #2a2e39;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            color: white;
            font-size: 13px;
            outline: none;
        }
        
        .chat-input::placeholder { color: #787b86; }
        
        .chat-send-btn {
            background: #2962ff;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        /* ==========================================
           SEARCH
           ========================================== */
        .search-container {
            padding: 16px;
            background: #000;
        }
        
        .search-input {
            width: 100%;
            background: #2a2e39;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            font-size: 15px;
            outline: none;
        }
        
        .search-input::placeholder { color: #787b86; }
        
        /* ==========================================
           COMMUNITY
           ========================================== */
        .community-post {
            padding: 16px;
            border-bottom: 1px solid #2a2e39;
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2962ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .post-user {
            font-weight: 600;
            font-size: 14px;
        }
        
        .post-time {
            font-size: 12px;
            color: #787b86;
        }
        
        .post-content {
            font-size: 14px;
            line-height: 1.5;
            color: #d1d4dc;
        }
        
        /* ==========================================
           SETTINGS
           ========================================== */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #2a2e39;
        }
        
        .settings-label {
            font-size: 15px;
        }
        
        .settings-value {
            color: #787b86;
            font-size: 14px;
        }
        
        /* ==========================================
           STATUS
           ========================================== */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-live { 
            background: #26a69a; 
            animation: pulse 2s infinite;
        }
        
        .status-offline { background: #ef5350; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 2px; }
    </style>
</head>
<body>
    <div class="app-container">
        
        <!-- ========== HEADER FIJO ========== -->
        <header class="app-header">
            <div class="flex items-center gap-3">
                <svg width="28" height="28" viewBox="0 0 36 36" fill="none">
                    <circle cx="18" cy="18" r="18" fill="#2962FF"/>
                    <path d="M10 18L16 24L26 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="font-bold text-lg">Terminal PRO</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="status-dot status-live" id="status-dot"></span>
                <span class="text-xs text-[#26a69a]" id="status-text">LIVE</span>
            </div>
        </header>
        
        <!-- ========== HOME VIEW ========== -->
        <div id="view-home" class="view active">
            
            <!-- Tabs FIJOS -->
            <div class="tabs-wrapper">
                <div class="tabs-container">
                    <button class="tab-btn tab-special">üî¥ Watch List</button>
                    <button class="tab-btn active" onclick="filterTab('all', this)">ALL</button>
                    <button class="tab-btn" onclick="filterTab('dow', this)">DOW 30</button>
                    <button class="tab-btn" onclick="filterTab('nasdaq', this)">NASDAQ 100</button>
                    <button class="tab-btn" onclick="filterTab('sp500', this)">S&P 500</button>
                </div>
            </div>
            
            <!-- Content con scroll -->
            <div class="content-wrapper" id="home-content">
                <!-- Se llena din√°micamente -->
            </div>
            
        </div>
        
        <!-- ========== CHART VIEW ========== -->
        <div id="view-chart" class="view">
            
            <div class="content-wrapper-no-tabs" style="display:flex;flex-direction:column;overflow:hidden;">
                <div class="chart-header">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="chart-ticker-large" id="chart-ticker">AAPL</div>
                            <div class="chart-name" id="chart-name">Apple Inc.</div>
                        </div>
                        <button onclick="switchView('home')" class="text-[#787b86] p-2">
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="chart-price-large" id="chart-price">$0.00</div>
                    <div class="chart-change-row">
                        <span id="chart-change" class="down">-0.00</span>
                        <span id="chart-pct" class="down">(-0.00%)</span>
                    </div>
                    <div class="flex gap-2 mt-3" id="chart-badges"></div>
                </div>
                
                <div id="chart-container"></div>
                
                <!-- Chat -->
                <div class="chat-container">
                    <div class="chat-header">
                        <span>üí¨ Chat en vivo - <span id="chat-ticker">AAPL</span></span>
                        <span id="chat-count">0 online</span>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message">
                            <div class="flex justify-between">
                                <span class="chat-message-user">Sistema</span>
                                <span class="chat-message-time">ahora</span>
                            </div>
                            <div class="chat-message-text">Bienvenido al chat. Comparte tus an√°lisis sobre este activo.</div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje...">
                        <button class="chat-send-btn" onclick="sendChatMessage()">
                            <svg width="18" height="18" fill="white" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- ========== SEARCH VIEW ========== -->
        <div id="view-search" class="view">
            <div class="content-wrapper-no-tabs">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="üîç Buscar ticker o empresa..." oninput="handleSearch(this.value)">
                </div>
                <div id="search-results">
                    <div class="p-4 text-center text-[#787b86]">
                        Busca cualquier activo por ticker o nombre
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== COMMUNITY VIEW ========== -->
        <div id="view-community" class="view">
            <div class="tabs-wrapper">
                <div class="tabs-container">
                    <button class="tab-btn active">üì∞ Tendencias</button>
                    <button class="tab-btn">üë• Siguiendo</button>
                    <button class="tab-btn">üí° Ideas</button>
                </div>
            </div>
            <div class="content-wrapper" id="community-content">
                <!-- Posts -->
            </div>
        </div>
        
        <!-- ========== SETTINGS VIEW ========== -->
        <div id="view-settings" class="view">
            <div class="content-wrapper-no-tabs">
                <div class="section-header">CUENTA</div>
                <div class="settings-item">
                    <span class="settings-label">Usuario</span>
                    <span class="settings-value">DonTrading_Pro</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Plan</span>
                    <span class="settings-value" style="color: #f7931a;">‚≠ê Polygon PRO</span>
                </div>
                
                <div class="section-header">CONEXI√ìN EN TIEMPO REAL</div>
                <div class="settings-item">
                    <span class="settings-label">Fuente de datos</span>
                    <span class="settings-value">Polygon.io</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">WebSocket</span>
                    <span class="settings-value" id="ws-status">Conectando...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Latencia</span>
                    <span class="settings-value" id="latency-display">--ms</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Tickers suscritos</span>
                    <span class="settings-value" id="tickers-count">0</span>
                </div>
                
                <div class="section-header">PREFERENCIAS</div>
                <div class="settings-item">
                    <span class="settings-label">Tema</span>
                    <span class="settings-value">üåô Oscuro</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Notificaciones</span>
                    <span class="settings-value">‚úÖ Activadas</span>
                </div>
                
                <div class="section-header">MERCADO NYSE/NASDAQ</div>
                <div class="settings-item">
                    <span class="settings-label">Estado</span>
                    <span class="settings-value" id="market-status">--</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Hora Nueva York</span>
                    <span class="settings-value" id="ny-time">--</span>
                </div>
                
                <div class="section-header">√çNDICES CARGADOS</div>
                <div class="settings-item">
                    <span class="settings-label">DOW JONES</span>
                    <span class="settings-value">30 componentes</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">NASDAQ 100</span>
                    <span class="settings-value">100 componentes</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">S&P 500</span>
                    <span class="settings-value">500 componentes</span>
                </div>
            </div>
        </div>
        
        <!-- ========== BOTTOM NAV FIJO ========== -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchView('home')" id="nav-home">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span>Inicio</span>
            </button>
            <button class="nav-item" onclick="switchView('chart')" id="nav-chart">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
                </svg>
                <span>Gr√°fico</span>
            </button>
            <button class="nav-item" onclick="switchView('search')" id="nav-search">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <span>Buscar</span>
            </button>
            <button class="nav-item" onclick="switchView('community')" id="nav-community">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
                <span>Noticias</span>
            </button>
            <button class="nav-item" onclick="switchView('settings')" id="nav-settings">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                </svg>
                <span>Ajustes</span>
            </button>
        </nav>
        
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN POLYGON PRO
        // ==========================================
        const API_KEY = 'Q3I6b14c8HL2l_A7faplgnuMTXekxCUU';
        let socket = null;
        let reconnectAttempts = 0;
        let lastMessageTime = Date.now();
        
        // ==========================================
        // DATOS COMPLETOS DE LOS 3 √çNDICES
        // DOW JONES: 30 componentes
        // NASDAQ 100: 100 componentes  
        // S&P 500: 500 componentes (top 100 aqu√≠)
        // ==========================================
        
        // DOW JONES - 30 COMPONENTES COMPLETOS
        const DOW_COMPONENTS = [
            { ticker: 'UNH', nombre: 'UnitedHealth Group Inc.', sector: 'Salud' },
            { ticker: 'GS', nombre: 'Goldman Sachs Group Inc.', sector: 'Finanzas' },
            { ticker: 'MSFT', nombre: 'Microsoft Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'HD', nombre: 'Home Depot Inc.', sector: 'Retail' },
            { ticker: 'CAT', nombre: 'Caterpillar Inc.', sector: 'Industrial' },
            { ticker: 'CRM', nombre: 'Salesforce Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'V', nombre: 'Visa Inc.', sector: 'Finanzas' },
            { ticker: 'AXP', nombre: 'American Express Co.', sector: 'Finanzas' },
            { ticker: 'MCD', nombre: "McDonald's Corporation", sector: 'Restaurantes' },
            { ticker: 'AMGN', nombre: 'Amgen Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'SHW', nombre: 'Sherwin-Williams Co.', sector: 'Materiales' },
            { ticker: 'TRV', nombre: 'Travelers Companies Inc.', sector: 'Seguros' },
            { ticker: 'JPM', nombre: 'JPMorgan Chase & Co.', sector: 'Finanzas' },
            { ticker: 'BA', nombre: 'Boeing Company', sector: 'Aeroespacial' },
            { ticker: 'IBM', nombre: 'IBM Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'AAPL', nombre: 'Apple Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'AMZN', nombre: 'Amazon.com Inc.', sector: 'E-commerce' },
            { ticker: 'HON', nombre: 'Honeywell International', sector: 'Industrial' },
            { ticker: 'JNJ', nombre: 'Johnson & Johnson', sector: 'Salud' },
            { ticker: 'PG', nombre: 'Procter & Gamble Co.', sector: 'Consumo' },
            { ticker: 'CVX', nombre: 'Chevron Corporation', sector: 'Energ√≠a' },
            { ticker: 'MRK', nombre: 'Merck & Co. Inc.', sector: 'Farmac√©utica' },
            { ticker: 'NKE', nombre: 'Nike Inc.', sector: 'Consumo' },
            { ticker: 'DIS', nombre: 'Walt Disney Company', sector: 'Entretenimiento' },
            { ticker: 'WMT', nombre: 'Walmart Inc.', sector: 'Retail' },
            { ticker: 'NVDA', nombre: 'NVIDIA Corporation', sector: 'Semiconductores' },
            { ticker: 'MMM', nombre: '3M Company', sector: 'Industrial' },
            { ticker: 'KO', nombre: 'Coca-Cola Company', sector: 'Bebidas' },
            { ticker: 'CSCO', nombre: 'Cisco Systems Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'VZ', nombre: 'Verizon Communications', sector: 'Telecom' }
        ];
        
        // NASDAQ 100 - 100 COMPONENTES
        const NASDAQ_COMPONENTS = [
            { ticker: 'AAPL', nombre: 'Apple Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'NVDA', nombre: 'NVIDIA Corporation', sector: 'Semiconductores' },
            { ticker: 'MSFT', nombre: 'Microsoft Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'AMZN', nombre: 'Amazon.com Inc.', sector: 'E-commerce' },
            { ticker: 'META', nombre: 'Meta Platforms Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'GOOGL', nombre: 'Alphabet Inc. Class A', sector: 'Tecnolog√≠a' },
            { ticker: 'GOOG', nombre: 'Alphabet Inc. Class C', sector: 'Tecnolog√≠a' },
            { ticker: 'TSLA', nombre: 'Tesla Inc.', sector: 'Automotriz' },
            { ticker: 'AVGO', nombre: 'Broadcom Inc.', sector: 'Semiconductores' },
            { ticker: 'COST', nombre: 'Costco Wholesale Corp.', sector: 'Retail' },
            { ticker: 'NFLX', nombre: 'Netflix Inc.', sector: 'Entretenimiento' },
            { ticker: 'AMD', nombre: 'Advanced Micro Devices', sector: 'Semiconductores' },
            { ticker: 'PEP', nombre: 'PepsiCo Inc.', sector: 'Bebidas' },
            { ticker: 'ADBE', nombre: 'Adobe Inc.', sector: 'Software' },
            { ticker: 'CSCO', nombre: 'Cisco Systems Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'TMUS', nombre: 'T-Mobile US Inc.', sector: 'Telecom' },
            { ticker: 'INTC', nombre: 'Intel Corporation', sector: 'Semiconductores' },
            { ticker: 'CMCSA', nombre: 'Comcast Corporation', sector: 'Telecom' },
            { ticker: 'INTU', nombre: 'Intuit Inc.', sector: 'Software' },
            { ticker: 'TXN', nombre: 'Texas Instruments', sector: 'Semiconductores' },
            { ticker: 'QCOM', nombre: 'Qualcomm Inc.', sector: 'Semiconductores' },
            { ticker: 'AMGN', nombre: 'Amgen Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'AMAT', nombre: 'Applied Materials Inc.', sector: 'Semiconductores' },
            { ticker: 'ISRG', nombre: 'Intuitive Surgical Inc.', sector: 'Salud' },
            { ticker: 'BKNG', nombre: 'Booking Holdings Inc.', sector: 'Viajes' },
            { ticker: 'HON', nombre: 'Honeywell International', sector: 'Industrial' },
            { ticker: 'VRTX', nombre: 'Vertex Pharmaceuticals', sector: 'Biotecnolog√≠a' },
            { ticker: 'LRCX', nombre: 'Lam Research Corp.', sector: 'Semiconductores' },
            { ticker: 'PANW', nombre: 'Palo Alto Networks', sector: 'Ciberseguridad' },
            { ticker: 'MU', nombre: 'Micron Technology Inc.', sector: 'Semiconductores' },
            { ticker: 'ADI', nombre: 'Analog Devices Inc.', sector: 'Semiconductores' },
            { ticker: 'KLAC', nombre: 'KLA Corporation', sector: 'Semiconductores' },
            { ticker: 'ADP', nombre: 'Automatic Data Processing', sector: 'Software' },
            { ticker: 'SBUX', nombre: 'Starbucks Corporation', sector: 'Restaurantes' },
            { ticker: 'GILD', nombre: 'Gilead Sciences Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'MDLZ', nombre: 'Mondelez International', sector: 'Consumo' },
            { ticker: 'REGN', nombre: 'Regeneron Pharmaceuticals', sector: 'Biotecnolog√≠a' },
            { ticker: 'SNPS', nombre: 'Synopsys Inc.', sector: 'Software' },
            { ticker: 'CDNS', nombre: 'Cadence Design Systems', sector: 'Software' },
            { ticker: 'MELI', nombre: 'MercadoLibre Inc.', sector: 'E-commerce' },
            { ticker: 'PYPL', nombre: 'PayPal Holdings Inc.', sector: 'Fintech' },
            { ticker: 'ASML', nombre: 'ASML Holding NV', sector: 'Semiconductores' },
            { ticker: 'ORLY', nombre: "O'Reilly Automotive", sector: 'Retail' },
            { ticker: 'CTAS', nombre: 'Cintas Corporation', sector: 'Industrial' },
            { ticker: 'MAR', nombre: 'Marriott International', sector: 'Hospitalidad' },
            { ticker: 'CSX', nombre: 'CSX Corporation', sector: 'Transporte' },
            { ticker: 'NXPI', nombre: 'NXP Semiconductors', sector: 'Semiconductores' },
            { ticker: 'PCAR', nombre: 'PACCAR Inc.', sector: 'Industrial' },
            { ticker: 'MRVL', nombre: 'Marvell Technology', sector: 'Semiconductores' },
            { ticker: 'WDAY', nombre: 'Workday Inc.', sector: 'Software' },
            { ticker: 'CPRT', nombre: 'Copart Inc.', sector: 'Industrial' },
            { ticker: 'DXCM', nombre: 'DexCom Inc.', sector: 'Salud' },
            { ticker: 'FTNT', nombre: 'Fortinet Inc.', sector: 'Ciberseguridad' },
            { ticker: 'MNST', nombre: 'Monster Beverage Corp.', sector: 'Bebidas' },
            { ticker: 'PAYX', nombre: 'Paychex Inc.', sector: 'Software' },
            { ticker: 'ODFL', nombre: 'Old Dominion Freight', sector: 'Transporte' },
            { ticker: 'ROST', nombre: 'Ross Stores Inc.', sector: 'Retail' },
            { ticker: 'KDP', nombre: 'Keurig Dr Pepper', sector: 'Bebidas' },
            { ticker: 'AZN', nombre: 'AstraZeneca PLC', sector: 'Farmac√©utica' },
            { ticker: 'KHC', nombre: 'Kraft Heinz Company', sector: 'Consumo' },
            { ticker: 'MCHP', nombre: 'Microchip Technology', sector: 'Semiconductores' },
            { ticker: 'AEP', nombre: 'American Electric Power', sector: 'Energ√≠a' },
            { ticker: 'EXC', nombre: 'Exelon Corporation', sector: 'Energ√≠a' },
            { ticker: 'LULU', nombre: 'Lululemon Athletica', sector: 'Retail' },
            { ticker: 'CEG', nombre: 'Constellation Energy', sector: 'Energ√≠a' },
            { ticker: 'GEHC', nombre: 'GE HealthCare Tech', sector: 'Salud' },
            { ticker: 'EA', nombre: 'Electronic Arts Inc.', sector: 'Entretenimiento' },
            { ticker: 'VRSK', nombre: 'Verisk Analytics', sector: 'Software' },
            { ticker: 'XEL', nombre: 'Xcel Energy Inc.', sector: 'Energ√≠a' },
            { ticker: 'BIIB', nombre: 'Biogen Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'FAST', nombre: 'Fastenal Company', sector: 'Industrial' },
            { ticker: 'TTWO', nombre: 'Take-Two Interactive', sector: 'Entretenimiento' },
            { ticker: 'IDXX', nombre: 'IDEXX Laboratories', sector: 'Salud' },
            { ticker: 'ON', nombre: 'ON Semiconductor', sector: 'Semiconductores' },
            { ticker: 'CDW', nombre: 'CDW Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'ZS', nombre: 'Zscaler Inc.', sector: 'Ciberseguridad' },
            { ticker: 'ANSS', nombre: 'ANSYS Inc.', sector: 'Software' },
            { ticker: 'GFS', nombre: 'GlobalFoundries Inc.', sector: 'Semiconductores' },
            { ticker: 'ILMN', nombre: 'Illumina Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'WBD', nombre: 'Warner Bros. Discovery', sector: 'Entretenimiento' },
            { ticker: 'TEAM', nombre: 'Atlassian Corp.', sector: 'Software' },
            { ticker: 'DLTR', nombre: 'Dollar Tree Inc.', sector: 'Retail' },
            { ticker: 'DDOG', nombre: 'Datadog Inc.', sector: 'Software' },
            { ticker: 'BKR', nombre: 'Baker Hughes Company', sector: 'Energ√≠a' },
            { ticker: 'FANG', nombre: 'Diamondback Energy', sector: 'Energ√≠a' },
            { ticker: 'CTSH', nombre: 'Cognizant Technology', sector: 'Tecnolog√≠a' },
            { ticker: 'WBA', nombre: 'Walgreens Boots Alliance', sector: 'Retail' },
            { ticker: 'CRWD', nombre: 'CrowdStrike Holdings', sector: 'Ciberseguridad' },
            { ticker: 'ZM', nombre: 'Zoom Video Communications', sector: 'Tecnolog√≠a' },
            { ticker: 'OKTA', nombre: 'Okta Inc.', sector: 'Software' },
            { ticker: 'SPLK', nombre: 'Splunk Inc.', sector: 'Software' },
            { ticker: 'LCID', nombre: 'Lucid Group Inc.', sector: 'Automotriz' },
            { ticker: 'RIVN', nombre: 'Rivian Automotive', sector: 'Automotriz' },
            { ticker: 'ABNB', nombre: 'Airbnb Inc.', sector: 'Viajes' },
            { ticker: 'DASH', nombre: 'DoorDash Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'COIN', nombre: 'Coinbase Global', sector: 'Fintech' },
            { ticker: 'HOOD', nombre: 'Robinhood Markets', sector: 'Fintech' },
            { ticker: 'PLTR', nombre: 'Palantir Technologies', sector: 'Software' },
            { ticker: 'SNOW', nombre: 'Snowflake Inc.', sector: 'Software' }
        ];
        
        // S&P 500 - TOP 100 COMPONENTES POR MARKET CAP
        const SP500_COMPONENTS = [
            { ticker: 'AAPL', nombre: 'Apple Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'MSFT', nombre: 'Microsoft Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'NVDA', nombre: 'NVIDIA Corporation', sector: 'Semiconductores' },
            { ticker: 'AMZN', nombre: 'Amazon.com Inc.', sector: 'E-commerce' },
            { ticker: 'GOOGL', nombre: 'Alphabet Inc. Class A', sector: 'Tecnolog√≠a' },
            { ticker: 'META', nombre: 'Meta Platforms Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'GOOG', nombre: 'Alphabet Inc. Class C', sector: 'Tecnolog√≠a' },
            { ticker: 'BRK.B', nombre: 'Berkshire Hathaway B', sector: 'Finanzas' },
            { ticker: 'LLY', nombre: 'Eli Lilly & Company', sector: 'Farmac√©utica' },
            { ticker: 'TSLA', nombre: 'Tesla Inc.', sector: 'Automotriz' },
            { ticker: 'UNH', nombre: 'UnitedHealth Group', sector: 'Salud' },
            { ticker: 'JPM', nombre: 'JPMorgan Chase & Co.', sector: 'Finanzas' },
            { ticker: 'V', nombre: 'Visa Inc.', sector: 'Finanzas' },
            { ticker: 'XOM', nombre: 'Exxon Mobil Corporation', sector: 'Energ√≠a' },
            { ticker: 'AVGO', nombre: 'Broadcom Inc.', sector: 'Semiconductores' },
            { ticker: 'MA', nombre: 'Mastercard Inc.', sector: 'Finanzas' },
            { ticker: 'JNJ', nombre: 'Johnson & Johnson', sector: 'Salud' },
            { ticker: 'PG', nombre: 'Procter & Gamble Co.', sector: 'Consumo' },
            { ticker: 'HD', nombre: 'Home Depot Inc.', sector: 'Retail' },
            { ticker: 'COST', nombre: 'Costco Wholesale Corp.', sector: 'Retail' },
            { ticker: 'MRK', nombre: 'Merck & Co. Inc.', sector: 'Farmac√©utica' },
            { ticker: 'ABBV', nombre: 'AbbVie Inc.', sector: 'Farmac√©utica' },
            { ticker: 'CVX', nombre: 'Chevron Corporation', sector: 'Energ√≠a' },
            { ticker: 'CRM', nombre: 'Salesforce Inc.', sector: 'Software' },
            { ticker: 'NFLX', nombre: 'Netflix Inc.', sector: 'Entretenimiento' },
            { ticker: 'AMD', nombre: 'Advanced Micro Devices', sector: 'Semiconductores' },
            { ticker: 'KO', nombre: 'Coca-Cola Company', sector: 'Bebidas' },
            { ticker: 'PEP', nombre: 'PepsiCo Inc.', sector: 'Bebidas' },
            { ticker: 'BAC', nombre: 'Bank of America Corp.', sector: 'Finanzas' },
            { ticker: 'WMT', nombre: 'Walmart Inc.', sector: 'Retail' },
            { ticker: 'TMO', nombre: 'Thermo Fisher Scientific', sector: 'Salud' },
            { ticker: 'ADBE', nombre: 'Adobe Inc.', sector: 'Software' },
            { ticker: 'MCD', nombre: "McDonald's Corporation", sector: 'Restaurantes' },
            { ticker: 'CSCO', nombre: 'Cisco Systems Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'WFC', nombre: 'Wells Fargo & Company', sector: 'Finanzas' },
            { ticker: 'ACN', nombre: 'Accenture PLC', sector: 'Tecnolog√≠a' },
            { ticker: 'ABT', nombre: 'Abbott Laboratories', sector: 'Salud' },
            { ticker: 'LIN', nombre: 'Linde PLC', sector: 'Materiales' },
            { ticker: 'DHR', nombre: 'Danaher Corporation', sector: 'Salud' },
            { ticker: 'ORCL', nombre: 'Oracle Corporation', sector: 'Software' },
            { ticker: 'TXN', nombre: 'Texas Instruments', sector: 'Semiconductores' },
            { ticker: 'CMCSA', nombre: 'Comcast Corporation', sector: 'Telecom' },
            { ticker: 'PM', nombre: 'Philip Morris International', sector: 'Tabaco' },
            { ticker: 'VZ', nombre: 'Verizon Communications', sector: 'Telecom' },
            { ticker: 'NEE', nombre: 'NextEra Energy Inc.', sector: 'Energ√≠a' },
            { ticker: 'INTC', nombre: 'Intel Corporation', sector: 'Semiconductores' },
            { ticker: 'DIS', nombre: 'Walt Disney Company', sector: 'Entretenimiento' },
            { ticker: 'RTX', nombre: 'RTX Corporation', sector: 'Defensa' },
            { ticker: 'INTU', nombre: 'Intuit Inc.', sector: 'Software' },
            { ticker: 'IBM', nombre: 'IBM Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'QCOM', nombre: 'Qualcomm Inc.', sector: 'Semiconductores' },
            { ticker: 'CAT', nombre: 'Caterpillar Inc.', sector: 'Industrial' },
            { ticker: 'AMGN', nombre: 'Amgen Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'NKE', nombre: 'Nike Inc.', sector: 'Consumo' },
            { ticker: 'HON', nombre: 'Honeywell International', sector: 'Industrial' },
            { ticker: 'GE', nombre: 'General Electric Co.', sector: 'Industrial' },
            { ticker: 'SPGI', nombre: 'S&P Global Inc.', sector: 'Finanzas' },
            { ticker: 'BA', nombre: 'Boeing Company', sector: 'Aeroespacial' },
            { ticker: 'GS', nombre: 'Goldman Sachs Group', sector: 'Finanzas' },
            { ticker: 'ISRG', nombre: 'Intuitive Surgical Inc.', sector: 'Salud' },
            { ticker: 'AXP', nombre: 'American Express Co.', sector: 'Finanzas' },
            { ticker: 'BKNG', nombre: 'Booking Holdings Inc.', sector: 'Viajes' },
            { ticker: 'SYK', nombre: 'Stryker Corporation', sector: 'Salud' },
            { ticker: 'VRTX', nombre: 'Vertex Pharmaceuticals', sector: 'Biotecnolog√≠a' },
            { ticker: 'MDLZ', nombre: 'Mondelez International', sector: 'Consumo' },
            { ticker: 'ELV', nombre: 'Elevance Health Inc.', sector: 'Salud' },
            { ticker: 'T', nombre: 'AT&T Inc.', sector: 'Telecom' },
            { ticker: 'MMC', nombre: 'Marsh & McLennan', sector: 'Finanzas' },
            { ticker: 'SCHW', nombre: 'Charles Schwab Corp.', sector: 'Finanzas' },
            { ticker: 'LOW', nombre: "Lowe's Companies", sector: 'Retail' },
            { ticker: 'BLK', nombre: 'BlackRock Inc.', sector: 'Finanzas' },
            { ticker: 'PLD', nombre: 'Prologis Inc.', sector: 'Real Estate' },
            { ticker: 'UPS', nombre: 'United Parcel Service', sector: 'Transporte' },
            { ticker: 'ADP', nombre: 'Automatic Data Processing', sector: 'Software' },
            { ticker: 'AMT', nombre: 'American Tower Corp.', sector: 'Real Estate' },
            { ticker: 'REGN', nombre: 'Regeneron Pharmaceuticals', sector: 'Biotecnolog√≠a' },
            { ticker: 'GILD', nombre: 'Gilead Sciences Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'LMT', nombre: 'Lockheed Martin Corp.', sector: 'Defensa' },
            { ticker: 'SBUX', nombre: 'Starbucks Corporation', sector: 'Restaurantes' },
            { ticker: 'PANW', nombre: 'Palo Alto Networks', sector: 'Ciberseguridad' },
            { ticker: 'MS', nombre: 'Morgan Stanley', sector: 'Finanzas' },
            { ticker: 'DE', nombre: 'Deere & Company', sector: 'Industrial' },
            { ticker: 'CB', nombre: 'Chubb Limited', sector: 'Seguros' },
            { ticker: 'CI', nombre: 'Cigna Group', sector: 'Salud' },
            { ticker: 'BMY', nombre: 'Bristol-Myers Squibb', sector: 'Farmac√©utica' },
            { ticker: 'ADI', nombre: 'Analog Devices Inc.', sector: 'Semiconductores' },
            { ticker: 'PFE', nombre: 'Pfizer Inc.', sector: 'Farmac√©utica' },
            { ticker: 'SLB', nombre: 'Schlumberger Limited', sector: 'Energ√≠a' },
            { ticker: 'FI', nombre: 'Fiserv Inc.', sector: 'Fintech' },
            { ticker: 'LRCX', nombre: 'Lam Research Corp.', sector: 'Semiconductores' },
            { ticker: 'SO', nombre: 'Southern Company', sector: 'Energ√≠a' },
            { ticker: 'DUK', nombre: 'Duke Energy Corp.', sector: 'Energ√≠a' },
            { ticker: 'MO', nombre: 'Altria Group Inc.', sector: 'Tabaco' },
            { ticker: 'CL', nombre: 'Colgate-Palmolive Co.', sector: 'Consumo' },
            { ticker: 'ICE', nombre: 'Intercontinental Exchange', sector: 'Finanzas' },
            { ticker: 'KLAC', nombre: 'KLA Corporation', sector: 'Semiconductores' },
            { ticker: 'AMAT', nombre: 'Applied Materials Inc.', sector: 'Semiconductores' },
            { ticker: 'CME', nombre: 'CME Group Inc.', sector: 'Finanzas' },
            { ticker: 'MU', nombre: 'Micron Technology Inc.', sector: 'Semiconductores' },
            { ticker: 'EQIX', nombre: 'Equinix Inc.', sector: 'Real Estate' }
        ];

        // ==========================================
        // ESTRUCTURAS DE DATOS
        // ==========================================
        const INDICES_DATA = {
            dow: {
                nombre: 'DOW JONES',
                total: 30,
                metodo: 'Price-Weighted',
                empresas: DOW_COMPONENTS.map(e => ({ ...e, price: 0, change: 0, changePercent: 0, weight: 0 }))
            },
            nasdaq: {
                nombre: 'NASDAQ 100',
                total: 100,
                metodo: 'Market-Cap Weighted',
                empresas: NASDAQ_COMPONENTS.map(e => ({ ...e, price: 0, change: 0, changePercent: 0, weight: 0 }))
            },
            sp500: {
                nombre: 'S&P 500',
                total: 500,
                metodo: 'Market-Cap Weighted',
                empresas: SP500_COMPONENTS.map(e => ({ ...e, price: 0, change: 0, changePercent: 0, weight: 0 }))
            }
        };

        // Variables globales
        let chart, candleSeries;
        let activoActual = null;
        let preciosEnTiempoReal = {};
        let datosHistoricos = {};
        let currentView = 'home';
        let currentFilter = 'all';
        let expandedSections = { dow: false, nasdaq: false, sp500: false };
        let onlineUsers = Math.floor(Math.random() * 500) + 100;

        // ==========================================
        // NAVEGACI√ìN
        // ==========================================
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${viewId}`).classList.add('active');
            
            currentView = viewId;
            
            if (viewId === 'chart' && chart) {
                setTimeout(() => {
                    const container = document.getElementById('chart-container');
                    chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
                }, 100);
            }
            
            if (viewId === 'community') {
                renderCommunity();
            }
        }

        function filterTab(filter, btn) {
            currentFilter = filter;
            // Reset expansiones al cambiar filtro
            expandedSections = { dow: false, nasdaq: false, sp500: false };
            
            document.querySelectorAll('.tabs-container .tab-btn:not(.tab-special)').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderHomeContent();
        }

        // ==========================================
        // CARGAR DATOS EN TIEMPO REAL
        // ==========================================
        async function cargarDatosIniciales() {
            updateStatus('loading', 'Cargando...');
            
            const allTickers = new Set();
            Object.values(INDICES_DATA).forEach(indice => {
                indice.empresas.forEach(e => {
                    if (!e.ticker.includes('.')) allTickers.add(e.ticker);
                });
            });
            
            document.getElementById('tickers-count').textContent = allTickers.size;
            
            const tickersArray = Array.from(allTickers);
            const batchSize = 50;
            
            for (let i = 0; i < tickersArray.length; i += batchSize) {
                const batch = tickersArray.slice(i, i + batchSize).join(',');
                const url = `https://api.polygon.io/v2/snapshot/locale/us/markets/stocks/tickers?tickers=${batch}&apiKey=${API_KEY}`;
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.tickers) {
                        data.tickers.forEach(t => {
                            const price = t.day?.c || t.prevDay?.c || 0;
                            const prevClose = t.prevDay?.c || price;
                            const change = price - prevClose;
                            const changePct = prevClose > 0 ? (change / prevClose) * 100 : 0;
                            
                            preciosEnTiempoReal[t.ticker] = price;
                            datosHistoricos[t.ticker] = {
                                previousClose: prevClose,
                                open: t.day?.o || prevClose,
                                high: t.day?.h || price,
                                low: t.day?.l || price,
                                change: change,
                                changePercent: changePct
                            };
                        });
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
                
                if (i + batchSize < tickersArray.length) {
                    await new Promise(r => setTimeout(r, 50));
                }
            }
            
            actualizarDatosEmpresas();
            calcularPesos();
            renderHomeContent();
            updateStatus('live', 'LIVE');
        }

        function actualizarDatosEmpresas() {
            Object.values(INDICES_DATA).forEach(indice => {
                indice.empresas.forEach(empresa => {
                    const precio = preciosEnTiempoReal[empresa.ticker];
                    const hist = datosHistoricos[empresa.ticker];
                    if (precio) empresa.price = precio;
                    if (hist) {
                        empresa.change = hist.change;
                        empresa.changePercent = hist.changePercent;
                    }
                });
            });
        }

        function calcularPesos() {
            // DOW - Price Weighted
            const dowEmpresas = INDICES_DATA.dow.empresas;
            const totalPrecio = dowEmpresas.reduce((sum, e) => sum + (e.price || 0), 0);
            if (totalPrecio > 0) {
                dowEmpresas.forEach(e => e.weight = ((e.price || 0) / totalPrecio) * 100);
            }
            dowEmpresas.sort((a, b) => b.weight - a.weight);
            
            // NASDAQ y S&P500 - Market Cap approximation
            ['nasdaq', 'sp500'].forEach(key => {
                const empresas = INDICES_DATA[key].empresas;
                let totalWeight = 0;
                empresas.forEach((e, i) => {
                    e.weight = Math.pow(0.92, i) * 10;
                    totalWeight += e.weight;
                });
                empresas.forEach(e => e.weight = (e.weight / totalWeight) * 100);
            });
        }

        // ==========================================
        // WEBSOCKET TIEMPO REAL
        // ==========================================
        function conectarWebSocket() {
            socket = new WebSocket('wss://socket.polygon.io/stocks');
            
            socket.onopen = () => {
                socket.send(JSON.stringify({ action: 'auth', params: API_KEY }));
            };
            
            socket.onmessage = (event) => {
                const latency = Date.now() - lastMessageTime;
                lastMessageTime = Date.now();
                document.getElementById('latency-display').textContent = `${Math.min(latency, 999)}ms`;
                
                const messages = JSON.parse(event.data);
                
                messages.forEach(msg => {
                    if (msg.ev === 'status') {
                        if (msg.status === 'auth_success') {
                            updateStatus('live', 'LIVE');
                            document.getElementById('ws-status').textContent = 'üü¢ Conectado';
                            document.getElementById('ws-status').style.color = '#26a69a';
                            reconnectAttempts = 0;
                            suscribirTickers();
                        }
                        return;
                    }
                    
                    if (msg.ev === 'T') {
                        procesarTrade(msg);
                    }
                    
                    if (msg.ev === 'AM' && activoActual && msg.sym === activoActual.ticker && candleSeries) {
                        candleSeries.update({
                            time: msg.s / 1000,
                            open: msg.o,
                            high: msg.h,
                            low: msg.l,
                            close: msg.c
                        });
                    }
                });
            };
            
            socket.onerror = () => {
                updateStatus('offline', 'ERROR');
                document.getElementById('ws-status').textContent = 'üî¥ Error';
            };
            
            socket.onclose = () => {
                updateStatus('offline', 'OFFLINE');
                document.getElementById('ws-status').textContent = 'üî¥ Desconectado';
                if (reconnectAttempts < 5) {
                    reconnectAttempts++;
                    setTimeout(conectarWebSocket, 2000 * reconnectAttempts);
                }
            };
        }

        function suscribirTickers() {
            const allTickers = new Set();
            Object.values(INDICES_DATA).forEach(indice => {
                indice.empresas.forEach(e => {
                    if (!e.ticker.includes('.')) allTickers.add(e.ticker);
                });
            });
            
            const subs = Array.from(allTickers).map(t => `T.${t},AM.${t}`).join(',');
            socket.send(JSON.stringify({ action: 'subscribe', params: subs }));
        }

        function procesarTrade(msg) {
            const ticker = msg.sym;
            const price = msg.p;
            
            preciosEnTiempoReal[ticker] = price;
            
            const hist = datosHistoricos[ticker];
            if (hist) {
                hist.change = price - hist.previousClose;
                hist.changePercent = hist.previousClose > 0 ? 
                    ((price - hist.previousClose) / hist.previousClose) * 100 : 0;
            }
            
            // Actualizar empresas
            Object.values(INDICES_DATA).forEach(indice => {
                const empresa = indice.empresas.find(e => e.ticker === ticker);
                if (empresa) {
                    empresa.price = price;
                    if (hist) {
                        empresa.change = hist.change;
                        empresa.changePercent = hist.changePercent;
                    }
                }
            });
            
            if (activoActual && ticker === activoActual.ticker) {
                updateChartPrice(price);
            }
            
            clearTimeout(window.renderTimeout);
            window.renderTimeout = setTimeout(() => {
                calcularPesos();
                renderHomeContent();
            }, 300);
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const textEl = document.getElementById('status-text');
            
            dot.className = 'status-dot ' + (status === 'live' ? 'status-live' : 'status-offline');
            textEl.textContent = text;
            textEl.style.color = status === 'live' ? '#26a69a' : (status === 'loading' ? '#f7931a' : '#ef5350');
        }

        // ==========================================
        // RENDERIZAR HOME
        // ==========================================
        function renderHomeContent() {
            const container = document.getElementById('home-content');
            let html = '';
            
            const indices = currentFilter === 'all' 
                ? ['dow', 'nasdaq', 'sp500'] 
                : [currentFilter];
            
            indices.forEach(key => {
                const indice = INDICES_DATA[key];
                const empresas = indice.empresas;
                const isExpanded = expandedSections[key];
                const showCount = isExpanded ? empresas.length : 10;
                const visibleEmpresas = empresas.slice(0, showCount);
                
                // Header de secci√≥n
                html += `
                    <div class="section-header">
                        <span>${indice.nombre}</span>
                        <span class="section-count">${isExpanded ? empresas.length : '10'} / ${indice.total} componentes</span>
                    </div>
                `;
                
                // Assets con ranking
                visibleEmpresas.forEach((empresa, index) => {
                    html += renderAssetItem(empresa, key, index + 1);
                });
                
                // Bot√≥n Ver m√°s / Ver menos
                if (empresas.length > 10) {
                    const remaining = empresas.length - 10;
                    html += `
                        <div class="ver-mas-btn" onclick="toggleSection('${key}')">
                            ${isExpanded 
                                ? '‚ñ≤ Ver menos (mostrar top 10)' 
                                : `‚ñº Ver m√°s (+${remaining} componentes)`
                            }
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function renderAssetItem(empresa, indiceKey, rank) {
            const isPositive = empresa.change >= 0;
            const colorClass = empresa.change === 0 ? 'neutral' : (isPositive ? 'up' : 'down');
            const sign = isPositive && empresa.change !== 0 ? '+' : '';
            
            return `
                <div class="asset-item" onclick="selectAsset('${empresa.ticker}', '${indiceKey}')">
                    <div class="asset-rank">#${rank}</div>
                    <div class="asset-logo">${getLogoHTML(empresa.ticker)}</div>
                    <div class="asset-info">
                        <div class="asset-ticker">${empresa.ticker}</div>
                        <div class="asset-name">${empresa.nombre}</div>
                    </div>
                    <div class="asset-data">
                        <div class="asset-price">${formatPrice(empresa.price)}</div>
                        <div class="asset-change">
                            <span class="${colorClass}">${sign}${empresa.change.toFixed(2)}</span>
                            <span class="${colorClass}">${sign}${empresa.changePercent.toFixed(2)}%</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleSection(key) {
            expandedSections[key] = !expandedSections[key];
            renderHomeContent();
            
            // Scroll al inicio de la secci√≥n si se expande
            if (expandedSections[key]) {
                setTimeout(() => {
                    const headers = document.querySelectorAll('.section-header');
                    const indexMap = { dow: 0, nasdaq: 1, sp500: 2 };
                    if (currentFilter === 'all' && headers[indexMap[key]]) {
                        headers[indexMap[key]].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        function getLogoHTML(ticker) {
            const colors = {
                'AAPL': '#A2AAAD', 'MSFT': '#00A4EF', 'GOOGL': '#4285F4', 'GOOG': '#4285F4',
                'AMZN': '#FF9900', 'META': '#1877F2', 'NVDA': '#76B900', 'TSLA': '#CC0000',
                'JPM': '#0A3D6E', 'V': '#1A1F71', 'MA': '#EB001B', 'BAC': '#012169',
                'HD': '#F96302', 'WMT': '#0071CE', 'KO': '#F40009', 'PEP': '#004B93',
                'NKE': '#000000', 'DIS': '#113CCF', 'NFLX': '#E50914', 'COST': '#E31837',
                'GS': '#6BA4D5', 'UNH': '#002677', 'CAT': '#FFCD00', 'CRM': '#00A1E0',
                'AMGN': '#0072CE', 'MCD': '#FFC72C', 'AXP': '#016FD0', 'IBM': '#0530AD'
            };
            
            const bg = colors[ticker] || '#2a2e39';
            return `<div style="width:100%;height:100%;background:${bg};display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:10px;font-weight:700;color:white;">${ticker.substring(0,2)}</div>`;
        }

        function formatPrice(price) {
            if (!price) return '--';
            return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ==========================================
        // SELECCIONAR ACTIVO
        // ==========================================
        async function selectAsset(ticker, indiceKey) {
            const empresa = INDICES_DATA[indiceKey].empresas.find(e => e.ticker === ticker);
            if (!empresa) return;
            
            activoActual = empresa;
            
            document.getElementById('chart-ticker').textContent = ticker;
            document.getElementById('chart-name').textContent = empresa.nombre;
            document.getElementById('chat-ticker').textContent = ticker;
            
            updateChartPrice(empresa.price);
            
            // Badges
            const badges = [];
            if (INDICES_DATA.dow.empresas.some(e => e.ticker === ticker)) badges.push('DOW');
            if (INDICES_DATA.nasdaq.empresas.some(e => e.ticker === ticker)) badges.push('NDX');
            if (INDICES_DATA.sp500.empresas.some(e => e.ticker === ticker)) badges.push('SPX');
            
            document.getElementById('chart-badges').innerHTML = badges.map(b => {
                const colors = { 'DOW': '#f7931a', 'NDX': '#00d4ff', 'SPX': '#26a69a' };
                return `<span style="font-size:11px;padding:4px 10px;border-radius:4px;background:${colors[b]}22;color:${colors[b]};border:1px solid ${colors[b]}44;">${b}</span>`;
            }).join('');
            
            switchView('chart');
            await cargarDatosGrafica(ticker);
        }

        function updateChartPrice(price) {
            if (!activoActual) return;
            
            const hist = datosHistoricos[activoActual.ticker];
            const change = hist?.change || 0;
            const changePct = hist?.changePercent || 0;
            const isPositive = change >= 0;
            const colorClass = change === 0 ? 'neutral' : (isPositive ? 'up' : 'down');
            const sign = isPositive && change !== 0 ? '+' : '';
            
            document.getElementById('chart-price').textContent = `$${formatPrice(price)}`;
            document.getElementById('chart-price').className = `chart-price-large ${colorClass}`;
            
            document.getElementById('chart-change').textContent = `${sign}${change.toFixed(2)}`;
            document.getElementById('chart-change').className = colorClass;
            
            document.getElementById('chart-pct').textContent = `(${sign}${changePct.toFixed(2)}%)`;
            document.getElementById('chart-pct').className = colorClass;
        }

        // ==========================================
        // GR√ÅFICA
        // ==========================================
        function crearGrafica() {
            const container = document.getElementById('chart-container');
            
            chart = LightweightCharts.createChart(container, {
                layout: { 
                    background: { color: '#131722' }, 
                    textColor: '#787b86' 
                },
                grid: { 
                    vertLines: { color: '#2a2e39' }, 
                    horzLines: { color: '#2a2e39' } 
                },
                timeScale: { 
                    timeVisible: true, 
                    secondsVisible: false,
                    borderColor: '#2a2e39' 
                },
                rightPriceScale: { borderColor: '#2a2e39' },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350'
            });

            const resizeObserver = new ResizeObserver(entries => {
                if (entries.length > 0) {
                    const { width, height } = entries[0].contentRect;
                    chart.applyOptions({ width, height });
                }
            });
            resizeObserver.observe(container);
        }

        async function cargarDatosGrafica(ticker) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            const from = startDate.toISOString().split('T')[0];
            const to = endDate.toISOString().split('T')[0];
            
            const url = `https://api.polygon.io/v2/aggs/ticker/${ticker}/range/5/minute/${from}/${to}?adjusted=true&sort=asc&limit=5000&apiKey=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const chartData = data.results.map(bar => ({
                        time: bar.t / 1000,
                        open: bar.o,
                        high: bar.h,
                        low: bar.l,
                        close: bar.c
                    }));
                    
                    candleSeries.setData(chartData);
                    chart.timeScale().fitContent();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ==========================================
        // B√öSQUEDA
        // ==========================================
        function handleSearch(query) {
            const container = document.getElementById('search-results');
            
            if (!query || query.length < 1) {
                container.innerHTML = '<div class="p-4 text-center text-[#787b86]">Busca cualquier activo por ticker o nombre</div>';
                return;
            }
            
            const results = [];
            const queryLower = query.toLowerCase();
            
            Object.entries(INDICES_DATA).forEach(([key, indice]) => {
                indice.empresas.forEach((empresa, index) => {
                    if (empresa.ticker.toLowerCase().includes(queryLower) || 
                        empresa.nombre.toLowerCase().includes(queryLower)) {
                        if (!results.find(r => r.ticker === empresa.ticker)) {
                            results.push({ ...empresa, indice: key, rank: index + 1 });
                        }
                    }
                });
            });
            
            if (results.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-[#787b86]">No se encontraron resultados</div>';
                return;
            }
            
            container.innerHTML = results.slice(0, 20).map(e => renderAssetItem(e, e.indice, e.rank)).join('');
        }

        // ==========================================
        // COMUNIDAD
        // ==========================================
        function renderCommunity() {
            const posts = [
                { user: 'TraderPro', avatar: 'TP', time: 'hace 5 min', content: 'üöÄ NVDA rompiendo m√°ximos! El momentum est√° incre√≠ble despu√©s del earnings. Long desde $140.' },
                { user: 'MarketWatch', avatar: 'MW', time: 'hace 12 min', content: 'El SPX muestra se√±ales de agotamiento en el RSI diario. Ojo con la resistencia en 5850.' },
                { user: 'TechAnalyst', avatar: 'TA', time: 'hace 28 min', content: 'AAPL con divergencia bajista en timeframe de 4H. Podr√≠a haber retroceso hacia $225.' },
                { user: 'SwingTrader', avatar: 'ST', time: 'hace 45 min', content: 'Entrada en AMZN hoy. El soporte en $185 aguant√≥ perfectamente. Target $205.' },
                { user: 'IndexFund', avatar: 'IF', time: 'hace 1 hora', content: 'El DOW recuper√°ndose bien. Los bancos (JPM, GS) est√°n empujando fuerte el √≠ndice.' },
                { user: 'OptionsKing', avatar: 'OK', time: 'hace 2 horas', content: 'IV en TSLA est√° elevada antes del evento. Vendi call spreads para aprovechar el crush.' }
            ];
            
            document.getElementById('community-content').innerHTML = posts.map(p => `
                <div class="community-post">
                    <div class="post-header">
                        <div class="post-avatar">${p.avatar}</div>
                        <div>
                            <div class="post-user">${p.user}</div>
                            <div class="post-time">${p.time}</div>
                        </div>
                    </div>
                    <div class="post-content">${p.content}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // CHAT
        // ==========================================
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatContainer = document.getElementById('chat-messages');
            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            chatContainer.insertAdjacentHTML('beforeend', `
                <div class="chat-message">
                    <div class="flex justify-between">
                        <span class="chat-message-user">T√∫</span>
                        <span class="chat-message-time">${time}</span>
                    </div>
                    <div class="chat-message-text">${message}</div>
                </div>
            `);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            input.value = '';
            
            // Respuesta simulada
            setTimeout(() => {
                const responses = [
                    'Interesante an√°lisis! üìä',
                    'De acuerdo contigo üëç',
                    'Hay que estar atentos al volumen',
                    'El mercado est√° muy vol√°til hoy',
                    'Buen punto, lo tendr√© en cuenta',
                    'Gracias por compartir!'
                ];
                const users = ['Trader123', 'MarketPro', 'StockGuru', 'AlphaSeeker'];
                
                chatContainer.insertAdjacentHTML('beforeend', `
                    <div class="chat-message">
                        <div class="flex justify-between">
                            <span class="chat-message-user">${users[Math.floor(Math.random() * users.length)]}</span>
                            <span class="chat-message-time">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <div class="chat-message-text">${responses[Math.floor(Math.random() * responses.length)]}</div>
                    </div>
                `);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1500 + Math.random() * 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
        });

        // ==========================================
        // MARKET STATUS
        // ==========================================
        function updateMarketStatus() {
            const now = new Date();
            const nyTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const hour = nyTime.getHours();
            const minute = nyTime.getMinutes();
            const day = nyTime.getDay();
            
            document.getElementById('ny-time').textContent = nyTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
            });
            
            let status = 'üî¥ Cerrado';
            
            if (day !== 0 && day !== 6) {
                const timeInMinutes = hour * 60 + minute;
                if (timeInMinutes >= 240 && timeInMinutes < 570) {
                    status = 'üü° Pre-Market';
                } else if (timeInMinutes >= 570 && timeInMinutes < 960) {
                    status = 'üü¢ Abierto';
                } else if (timeInMinutes >= 960 && timeInMinutes < 1200) {
                    status = 'üîµ After Hours';
                }
            }
            
            document.getElementById('market-status').textContent = status;
            
            onlineUsers += Math.floor(Math.random() * 10) - 5;
            onlineUsers = Math.max(50, Math.min(800, onlineUsers));
            document.getElementById('chat-count').textContent = `${onlineUsers} online`;
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        window.onload = async () => {
            crearGrafica();
            updateMarketStatus();
            setInterval(updateMarketStatus, 30000);
            
            await cargarDatosIniciales();
            conectarWebSocket();
        };
        
        window.onbeforeunload = () => {
            if (socket) socket.close();
        };
    </script>
</body>
</html>