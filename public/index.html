<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Terminal PRO v9.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            background: #000000;
            color: #ffffff;
            height: 100%;
            overflow: hidden;
        }
        
        .up { color: #26a69a !important; }
        .down { color: #ef5350 !important; }
        .neutral { color: #787b86 !important; }
        
        /* ==========================================
           LAYOUT PRINCIPAL
           ========================================== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            position: relative;
        }
        
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: #131722;
            border-bottom: 1px solid #2a2e39;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tabs-wrapper {
            position: fixed;
            top: 52px;
            left: 0;
            right: 0;
            z-index: 99;
            background: #131722;
            border-bottom: 1px solid #2a2e39;
        }
        
        .tabs-container {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tabs-container::-webkit-scrollbar { display: none; }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-around;
            background: #131722;
            border-top: 1px solid #2a2e39;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }
        
        .content-wrapper {
            flex: 1;
            margin-top: 96px;
            margin-bottom: 70px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .content-wrapper-no-tabs {
            flex: 1;
            margin-top: 52px;
            margin-bottom: 70px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* ==========================================
           TABS
           ========================================== */
        .tab-btn {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #787b86;
            white-space: nowrap;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn:hover { color: #d1d4dc; }
        .tab-btn.active { 
            color: #2962ff; 
            border-bottom-color: #2962ff;
        }
        
        .tab-watchlist {
            background: linear-gradient(135deg, #f7931a 0%, #ff6b00 100%);
            color: white !important;
            border-radius: 4px;
            margin: 8px;
            padding: 6px 12px !important;
            font-size: 11px !important;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
        }
        
        .tab-watchlist:hover {
            background: linear-gradient(135deg, #ff9500 0%, #ff7700 100%);
        }
        
        .watchlist-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        
        /* ==========================================
           SECTION HEADERS
           ========================================== */
        .section-header {
            padding: 16px 16px 8px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #000;
            position: sticky;
            top: 0;
            z-index: 5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-count {
            font-size: 10px;
            color: #2962ff;
            font-weight: 500;
        }
        
        /* ==========================================
           ASSET ITEMS
           ========================================== */
        .asset-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(42, 46, 57, 0.5);
            transition: background 0.15s;
        }
        
        .asset-item:hover { background: #1e222d; }
        .asset-item:active { background: #2a2e39; }
        
        .asset-rank {
            width: 28px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            flex-shrink: 0;
        }
        
        .asset-logo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2a2e39;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-size: 11px;
            font-weight: 700;
            color: #787b86;
            overflow: hidden;
            cursor: pointer;
        }
        
        .asset-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }
        
        .asset-ticker {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .asset-name {
            font-size: 12px;
            color: #787b86;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .asset-data {
            text-align: right;
            flex-shrink: 0;
            margin-left: 8px;
            cursor: pointer;
        }
        
        .asset-price {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .asset-change {
            font-size: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 6px;
        }
        
        /* ==========================================
           FAVORITE STAR BUTTON - MEJORADO
           ========================================== */
        .favorite-btn {
            width: 44px;
            height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.2s, color 0.2s;
            flex-shrink: 0;
            margin-left: 4px;
            border-radius: 50%;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .favorite-btn:hover {
            background: rgba(247, 147, 26, 0.1);
            transform: scale(1.1);
        }
        
        .favorite-btn:active {
            transform: scale(0.95);
        }
        
        .favorite-btn.active {
            color: #f7931a;
        }
        
        .favorite-btn:not(.active) {
            color: #555;
        }
        
        @keyframes star-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .favorite-btn.just-added {
            animation: star-pop 0.3s ease;
        }
        
        .ver-mas-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px;
            color: #2962ff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 1px solid rgba(42, 46, 57, 0.5);
            background: rgba(41, 98, 255, 0.05);
        }
        
        .ver-mas-btn:hover { background: rgba(41, 98, 255, 0.1); }
        
        /* ==========================================
           NAV ITEMS
           ========================================== */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            color: #787b86;
            font-size: 10px;
            cursor: pointer;
            transition: color 0.2s;
            border: none;
            background: none;
        }
        
        .nav-item:hover, .nav-item.active { color: #2962ff; }
        
        .nav-icon {
            width: 24px;
            height: 24px;
        }
        
        /* ==========================================
           VIEWS
           ========================================== */
        .view {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        
        .view.active {
            display: flex;
        }
        
        /* ==========================================
           REELS STYLE
           ========================================== */
        .reels-container {
            position: fixed;
            top: 52px;
            left: 0;
            right: 0;
            bottom: 70px;
            overflow: hidden;
            background: #000;
        }
        
        .reels-horizontal {
            display: flex;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }
        
        .reels-index-column {
            min-width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .reels-vertical {
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }
        
        .reel-card {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }
        
        .reels-index-tabs {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 10px 8px;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            flex-wrap: wrap;
        }
        
        .reels-index-tab {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            background: rgba(42, 46, 57, 0.5);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reels-index-tab.active {
            color: #fff;
            background: #2962ff;
        }
        
        .reels-index-tab.watchlist-tab {
            background: rgba(247, 147, 26, 0.3);
            color: #f7931a;
        }
        
        .reels-index-tab.watchlist-tab.active {
            background: #f7931a;
            color: #fff;
        }
        
        /* Contador movido a la izquierda para no interferir con la estrella */
        .reels-counter {
            position: absolute;
            top: 50px;
            left: 16px;
            font-size: 11px;
            color: #787b86;
            background: rgba(0,0,0,0.6);
            padding: 4px 10px;
            border-radius: 12px;
            z-index: 10;
        }
        
        /* Indicador de loop infinito */
        .loop-indicator {
            position: absolute;
            top: 50px;
            right: 16px;
            font-size: 10px;
            color: #2962ff;
            background: rgba(41, 98, 255, 0.2);
            padding: 4px 8px;
            border-radius: 10px;
            z-index: 10;
        }
        
        .swipe-hint {
            position: absolute;
            font-size: 10px;
            color: rgba(120, 123, 134, 0.5);
            z-index: 10;
        }
        
        .swipe-hint-vertical {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .swipe-hint-horizontal {
            top: 50%;
            right: 10px;
            transform: translateY(-50%) rotate(-90deg);
        }
        
        @media (max-width: 768px) {
            .swipe-hint { display: none; }
        }
        
        .reel-header {
            padding: 55px 16px 10px;
            background: linear-gradient(to bottom, transparent 0%, #131722 100%);
        }
        
        .reel-top-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        
        .reel-ticker-info {
            flex: 1;
        }
        
        .reel-ticker {
            font-size: 26px;
            font-weight: 700;
        }
        
        .reel-name {
            font-size: 12px;
            color: #787b86;
            margin-top: 2px;
        }
        
        /* Bot√≥n de favorito en Reels - MEJORADO */
        .reel-favorite-btn {
            width: 50px;
            height: 50px;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: rgba(42, 46, 57, 0.7);
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .reel-favorite-btn:hover {
            background: rgba(247, 147, 26, 0.3);
            transform: scale(1.05);
        }
        
        .reel-favorite-btn:active {
            transform: scale(0.95);
        }
        
        .reel-favorite-btn.active {
            background: rgba(247, 147, 26, 0.3);
            color: #f7931a;
        }
        
        .reel-favorite-btn:not(.active) {
            color: #787b86;
        }
        
        .reel-price {
            font-size: 32px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .reel-change-row {
            display: flex;
            gap: 12px;
            margin-top: 4px;
            font-size: 14px;
        }
        
        .reel-badges {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .reel-badge {
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 4px;
        }
        
        .reel-chart {
            flex: 1;
            background: #131722;
            min-height: 150px;
        }
        
        .reel-chat {
            background: #131722;
            border-top: 1px solid #2a2e39;
            height: 130px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .chat-header {
            padding: 6px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 6px 16px;
            font-size: 11px;
        }
        
        .chat-message {
            padding: 3px 0;
        }
        
        .chat-message-user {
            color: #2962ff;
            font-weight: 500;
        }
        
        .chat-message-text {
            color: #d1d4dc;
            display: inline;
            margin-left: 6px;
        }
        
        .chat-input-container {
            display: flex;
            padding: 6px 16px;
            gap: 8px;
            border-top: 1px solid #2a2e39;
            flex-shrink: 0;
        }
        
        .chat-input {
            flex: 1;
            background: #2a2e39;
            border: none;
            border-radius: 20px;
            padding: 8px 14px;
            color: white;
            font-size: 12px;
            outline: none;
        }
        
        .chat-input::placeholder { color: #787b86; }
        
        .chat-send-btn {
            background: #2962ff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        /* Navigation arrows - SOLO DESKTOP */
        .nav-arrow {
            position: absolute;
            z-index: 20;
            background: rgba(41, 98, 255, 0.3);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            opacity: 0.7;
        }
        
        .nav-arrow:hover {
            background: rgba(41, 98, 255, 0.6);
            opacity: 1;
        }
        
        @media (min-width: 769px) {
            .nav-arrow { display: flex; }
        }
        
        .nav-arrow-up { top: 65px; left: 50%; transform: translateX(-50%); }
        .nav-arrow-down { bottom: 150px; left: 50%; transform: translateX(-50%); }
        .nav-arrow-left { left: 10px; top: 50%; transform: translateY(-50%); }
        .nav-arrow-right { right: 10px; top: 50%; transform: translateY(-50%); }
        
        /* ==========================================
           EMPTY STATE
           ========================================== */
        .empty-watchlist {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #787b86;
            text-align: center;
            padding: 40px;
        }
        
        .empty-watchlist-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-watchlist-title {
            font-size: 18px;
            font-weight: 600;
            color: #d1d4dc;
            margin-bottom: 8px;
        }
        
        .empty-watchlist-text {
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* ==========================================
           OTHER VIEWS
           ========================================== */
        .search-container {
            padding: 16px;
            background: #000;
        }
        
        .search-input {
            width: 100%;
            background: #2a2e39;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            font-size: 15px;
            outline: none;
        }
        
        .search-input::placeholder { color: #787b86; }
        
        .community-post {
            padding: 16px;
            border-bottom: 1px solid #2a2e39;
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2962ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .post-user { font-weight: 600; font-size: 14px; }
        .post-time { font-size: 12px; color: #787b86; }
        .post-content { font-size: 14px; line-height: 1.5; color: #d1d4dc; }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #2a2e39;
        }
        
        .settings-label { font-size: 15px; }
        .settings-value { color: #787b86; font-size: 14px; }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-live { 
            background: #26a69a; 
            animation: pulse 2s infinite;
        }
        
        .status-offline { background: #ef5350; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 2px; }
    </style>
</head>
<body>
    <div class="app-container">
        
        <!-- ========== HEADER ========== -->
        <header class="app-header">
            <div class="flex items-center gap-3">
                <svg width="28" height="28" viewBox="0 0 36 36" fill="none">
                    <circle cx="18" cy="18" r="18" fill="#2962FF"/>
                    <path d="M10 18L16 24L26 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="font-bold text-lg">Terminal PRO</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="status-dot status-live" id="status-dot"></span>
                <span class="text-xs text-[#26a69a]" id="status-text">LIVE</span>
            </div>
        </header>
        
        <!-- ========== HOME VIEW ========== -->
        <div id="view-home" class="view active">
            <div class="tabs-wrapper">
                <div class="tabs-container">
                    <button class="tab-btn tab-watchlist" onclick="openWatchlistReels()">
                        ‚≠ê Watch List
                        <span class="watchlist-count" id="watchlist-count-home">0</span>
                    </button>
                    <button class="tab-btn active" onclick="filterTab('all', this)">ALL</button>
                    <button class="tab-btn" onclick="filterTab('dow', this)">DOW 30</button>
                    <button class="tab-btn" onclick="filterTab('nasdaq', this)">NASDAQ 100</button>
                    <button class="tab-btn" onclick="filterTab('sp500', this)">S&P 500</button>
                </div>
            </div>
            <div class="content-wrapper" id="home-content"></div>
        </div>
        
        <!-- ========== CHART VIEW (REELS) ========== -->
        <div id="view-chart" class="view">
            <div class="reels-container" id="reels-container">
                
                <div class="reels-index-tabs" id="reels-tabs">
                    <div class="reels-index-tab watchlist-tab" data-index="watchlist" onclick="switchReelIndex('watchlist')">‚≠ê Favoritos</div>
                    <div class="reels-index-tab" data-index="dow" onclick="switchReelIndex('dow')">DOW</div>
                    <div class="reels-index-tab active" data-index="nasdaq" onclick="switchReelIndex('nasdaq')">NASDAQ</div>
                    <div class="reels-index-tab" data-index="sp500" onclick="switchReelIndex('sp500')">S&P 500</div>
                </div>
                
                <!-- Contador movido a la izquierda -->
                <div class="reels-counter" id="reels-counter">1 / 30</div>
                
                <!-- Indicador de loop -->
                
                <button class="nav-arrow nav-arrow-up" onclick="navigateReel('up')">‚ñ≤</button>
                <button class="nav-arrow nav-arrow-down" onclick="navigateReel('down')">‚ñº</button>
                <button class="nav-arrow nav-arrow-left" onclick="navigateReel('left')">‚óÄ</button>
                <button class="nav-arrow nav-arrow-right" onclick="navigateReel('right')">‚ñ∂</button>
                
                <div class="reels-horizontal" id="reels-horizontal">
                    <div class="reels-index-column" data-index="watchlist">
                        <div class="reels-vertical" id="reels-vertical-watchlist"></div>
                    </div>
                    <div class="reels-index-column" data-index="dow">
                        <div class="reels-vertical" id="reels-vertical-dow"></div>
                    </div>
                    <div class="reels-index-column" data-index="nasdaq">
                        <div class="reels-vertical" id="reels-vertical-nasdaq"></div>
                    </div>
                    <div class="reels-index-column" data-index="sp500">
                        <div class="reels-vertical" id="reels-vertical-sp500"></div>
                    </div>
                </div>
                
                <div class="swipe-hint swipe-hint-vertical">‚Üë‚Üì Cambiar activo</div>
                <div class="swipe-hint swipe-hint-horizontal">‚Üê ‚Üí √çndice</div>
            </div>
        </div>
        
        <!-- ========== SEARCH VIEW ========== -->
        <div id="view-search" class="view">
            <div class="content-wrapper-no-tabs">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="üîç Buscar ticker o empresa..." oninput="handleSearch(this.value)">
                </div>
                <div id="search-results">
                    <div class="p-4 text-center text-[#787b86]">Busca cualquier activo por ticker o nombre</div>
                </div>
            </div>
        </div>
        
        <!-- ========== COMMUNITY VIEW ========== -->
        <div id="view-community" class="view">
            <div class="tabs-wrapper">
                <div class="tabs-container">
                    <button class="tab-btn active">üì∞ Tendencias</button>
                    <button class="tab-btn">üë• Siguiendo</button>
                    <button class="tab-btn">üí° Ideas</button>
                </div>
            </div>
            <div class="content-wrapper" id="community-content"></div>
        </div>
        
        <!-- ========== SETTINGS VIEW ========== -->
        <div id="view-settings" class="view">
            <div class="content-wrapper-no-tabs">
                <div class="section-header">CUENTA</div>
                <div class="settings-item">
                    <span class="settings-label">Usuario</span>
                    <span class="settings-value">DonTrading_Pro</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Plan</span>
                    <span class="settings-value" style="color: #f7931a;">‚≠ê Polygon PRO</span>
                </div>
                
                <div class="section-header">WATCH LIST</div>
                <div class="settings-item">
                    <span class="settings-label">Favoritos guardados</span>
                    <span class="settings-value" id="watchlist-count-settings">0</span>
                </div>
                <div class="settings-item" style="cursor:pointer;color:#ef5350;" onclick="clearWatchlist()">
                    <span class="settings-label">üóëÔ∏è Limpiar Watch List</span>
                    <span class="settings-value">‚Üí</span>
                </div>
                
                <div class="section-header">CONEXI√ìN</div>
                <div class="settings-item">
                    <span class="settings-label">WebSocket</span>
                    <span class="settings-value" id="ws-status">Conectando...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Latencia</span>
                    <span class="settings-value" id="latency-display">--ms</span>
                </div>
                
                <div class="section-header">MERCADO</div>
                <div class="settings-item">
                    <span class="settings-label">Estado</span>
                    <span class="settings-value" id="market-status">--</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Hora NY</span>
                    <span class="settings-value" id="ny-time">--</span>
                </div>
            </div>
        </div>
        
        <!-- ========== BOTTOM NAV ========== -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchView('home')" id="nav-home">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span>Inicio</span>
            </button>
            <button class="nav-item" onclick="switchView('chart')" id="nav-chart">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
                </svg>
                <span>Gr√°fico</span>
            </button>
            <button class="nav-item" onclick="switchView('search')" id="nav-search">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <span>Buscar</span>
            </button>
            <button class="nav-item" onclick="switchView('community')" id="nav-community">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
                <span>Noticias</span>
            </button>
            <button class="nav-item" onclick="switchView('settings')" id="nav-settings">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                </svg>
                <span>Ajustes</span>
            </button>
        </nav>
        
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const API_KEY = 'Q3I6b14c8HL2l_A7faplgnuMTXekxCUU';
        let socket = null;
        let reconnectAttempts = 0;
        let lastMessageTime = Date.now();
        
        // ==========================================
        // WATCH LIST (FAVORITOS) - MEJORADO
        // ==========================================
        let watchlist = JSON.parse(localStorage.getItem('tradingWatchlist') || '[]');
        
        function saveWatchlist() {
            localStorage.setItem('tradingWatchlist', JSON.stringify(watchlist));
            updateWatchlistCounts();
        }
        
        function toggleFavorite(ticker, event) {
            // Prevenir propagaci√≥n del evento
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const index = watchlist.indexOf(ticker);
            const wasAdded = index === -1;
            
            if (index > -1) {
                watchlist.splice(index, 1);
            } else {
                watchlist.push(ticker);
            }
            
            saveWatchlist();
            
            // Actualizar TODOS los botones de favoritos con este ticker
            document.querySelectorAll(`[data-ticker="${ticker}"]`).forEach(btn => {
                const isNowFavorite = watchlist.includes(ticker);
                btn.classList.toggle('active', isNowFavorite);
                
                // Animaci√≥n solo si se agreg√≥
                if (wasAdded) {
                    btn.classList.add('just-added');
                    setTimeout(() => btn.classList.remove('just-added'), 300);
                }
                
                // Actualizar texto/emoji
                if (btn.classList.contains('reel-favorite-btn') || btn.classList.contains('favorite-btn')) {
                    btn.textContent = isNowFavorite ? '‚≠ê' : '‚òÜ';
                }
            });
            
            // Re-renderizar home si estamos ah√≠
            if (currentView === 'home') {
                renderHomeContent();
            }
            
            // Re-renderizar b√∫squeda si hay resultados
            const searchInput = document.getElementById('search-input');
            if (searchInput && searchInput.value) {
                handleSearch(searchInput.value);
            }
            
            // Actualizar watchlist cards si estamos en reels
            if (currentView === 'chart' && reelsState.currentIndexKey === 'watchlist') {
                buildWatchlistCards();
                updateReelsPosition();
            }
        }
        
        function isFavorite(ticker) {
            return watchlist.includes(ticker);
        }
        
        function updateWatchlistCounts() {
            const count = watchlist.length;
            const homeCount = document.getElementById('watchlist-count-home');
            const settingsCount = document.getElementById('watchlist-count-settings');
            if (homeCount) homeCount.textContent = count;
            if (settingsCount) settingsCount.textContent = count;
        }
        
        function clearWatchlist() {
            if (confirm('¬øEliminar todos los favoritos?')) {
                watchlist = [];
                saveWatchlist();
                renderHomeContent();
                if (currentView === 'chart') {
                    buildWatchlistCards();
                    updateReelsPosition();
                }
            }
        }
        
        function getWatchlistEmpresas() {
            const empresas = [];
            watchlist.forEach(ticker => {
                for (const [key, indice] of Object.entries(INDICES_DATA)) {
                    const empresa = indice.empresas.find(e => e.ticker === ticker);
                    if (empresa && !empresas.find(e => e.ticker === ticker)) {
                        empresas.push({ ...empresa, sourceIndex: key });
                        break;
                    }
                }
            });
            return empresas;
        }
        
        // Watch List ahora siempre accesible (no bloqueado)
        function openWatchlistReels() {
            reelsState.currentIndexKey = 'watchlist';
            reelsState.currentAssetIndex.watchlist = 0;
            switchView('chart');
        }
        
        // ==========================================
        // DATOS DE √çNDICES
        // ==========================================
        const DOW_COMPONENTS = [
            { ticker: 'UNH', nombre: 'UnitedHealth Group Inc.', sector: 'Salud' },
            { ticker: 'GS', nombre: 'Goldman Sachs Group Inc.', sector: 'Finanzas' },
            { ticker: 'MSFT', nombre: 'Microsoft Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'HD', nombre: 'Home Depot Inc.', sector: 'Retail' },
            { ticker: 'CAT', nombre: 'Caterpillar Inc.', sector: 'Industrial' },
            { ticker: 'CRM', nombre: 'Salesforce Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'V', nombre: 'Visa Inc.', sector: 'Finanzas' },
            { ticker: 'AXP', nombre: 'American Express Co.', sector: 'Finanzas' },
            { ticker: 'MCD', nombre: "McDonald's Corporation", sector: 'Restaurantes' },
            { ticker: 'AMGN', nombre: 'Amgen Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'SHW', nombre: 'Sherwin-Williams Co.', sector: 'Materiales' },
            { ticker: 'TRV', nombre: 'Travelers Companies Inc.', sector: 'Seguros' },
            { ticker: 'JPM', nombre: 'JPMorgan Chase & Co.', sector: 'Finanzas' },
            { ticker: 'BA', nombre: 'Boeing Company', sector: 'Aeroespacial' },
            { ticker: 'IBM', nombre: 'IBM Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'AAPL', nombre: 'Apple Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'AMZN', nombre: 'Amazon.com Inc.', sector: 'E-commerce' },
            { ticker: 'HON', nombre: 'Honeywell International', sector: 'Industrial' },
            { ticker: 'JNJ', nombre: 'Johnson & Johnson', sector: 'Salud' },
            { ticker: 'PG', nombre: 'Procter & Gamble Co.', sector: 'Consumo' },
            { ticker: 'CVX', nombre: 'Chevron Corporation', sector: 'Energ√≠a' },
            { ticker: 'MRK', nombre: 'Merck & Co. Inc.', sector: 'Farmac√©utica' },
            { ticker: 'NKE', nombre: 'Nike Inc.', sector: 'Consumo' },
            { ticker: 'DIS', nombre: 'Walt Disney Company', sector: 'Entretenimiento' },
            { ticker: 'WMT', nombre: 'Walmart Inc.', sector: 'Retail' },
            { ticker: 'NVDA', nombre: 'NVIDIA Corporation', sector: 'Semiconductores' },
            { ticker: 'MMM', nombre: '3M Company', sector: 'Industrial' },
            { ticker: 'KO', nombre: 'Coca-Cola Company', sector: 'Bebidas' },
            { ticker: 'CSCO', nombre: 'Cisco Systems Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'VZ', nombre: 'Verizon Communications', sector: 'Telecom' }
        ];
        
        const NASDAQ_COMPONENTS = [
            { ticker: 'AAPL', nombre: 'Apple Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'NVDA', nombre: 'NVIDIA Corporation', sector: 'Semiconductores' },
            { ticker: 'MSFT', nombre: 'Microsoft Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'AMZN', nombre: 'Amazon.com Inc.', sector: 'E-commerce' },
            { ticker: 'META', nombre: 'Meta Platforms Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'GOOGL', nombre: 'Alphabet Inc. Class A', sector: 'Tecnolog√≠a' },
            { ticker: 'GOOG', nombre: 'Alphabet Inc. Class C', sector: 'Tecnolog√≠a' },
            { ticker: 'TSLA', nombre: 'Tesla Inc.', sector: 'Automotriz' },
            { ticker: 'AVGO', nombre: 'Broadcom Inc.', sector: 'Semiconductores' },
            { ticker: 'COST', nombre: 'Costco Wholesale Corp.', sector: 'Retail' },
            { ticker: 'NFLX', nombre: 'Netflix Inc.', sector: 'Entretenimiento' },
            { ticker: 'AMD', nombre: 'Advanced Micro Devices', sector: 'Semiconductores' },
            { ticker: 'PEP', nombre: 'PepsiCo Inc.', sector: 'Bebidas' },
            { ticker: 'ADBE', nombre: 'Adobe Inc.', sector: 'Software' },
            { ticker: 'CSCO', nombre: 'Cisco Systems Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'TMUS', nombre: 'T-Mobile US Inc.', sector: 'Telecom' },
            { ticker: 'INTC', nombre: 'Intel Corporation', sector: 'Semiconductores' },
            { ticker: 'CMCSA', nombre: 'Comcast Corporation', sector: 'Telecom' },
            { ticker: 'INTU', nombre: 'Intuit Inc.', sector: 'Software' },
            { ticker: 'TXN', nombre: 'Texas Instruments', sector: 'Semiconductores' },
            { ticker: 'QCOM', nombre: 'Qualcomm Inc.', sector: 'Semiconductores' },
            { ticker: 'AMGN', nombre: 'Amgen Inc.', sector: 'Biotecnolog√≠a' },
            { ticker: 'AMAT', nombre: 'Applied Materials Inc.', sector: 'Semiconductores' },
            { ticker: 'ISRG', nombre: 'Intuitive Surgical Inc.', sector: 'Salud' },
            { ticker: 'BKNG', nombre: 'Booking Holdings Inc.', sector: 'Viajes' },
            { ticker: 'HON', nombre: 'Honeywell International', sector: 'Industrial' },
            { ticker: 'VRTX', nombre: 'Vertex Pharmaceuticals', sector: 'Biotecnolog√≠a' },
            { ticker: 'LRCX', nombre: 'Lam Research Corp.', sector: 'Semiconductores' },
            { ticker: 'PANW', nombre: 'Palo Alto Networks', sector: 'Ciberseguridad' },
            { ticker: 'MU', nombre: 'Micron Technology Inc.', sector: 'Semiconductores' }
        ];
        
        const SP500_COMPONENTS = [
            { ticker: 'AAPL', nombre: 'Apple Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'MSFT', nombre: 'Microsoft Corporation', sector: 'Tecnolog√≠a' },
            { ticker: 'NVDA', nombre: 'NVIDIA Corporation', sector: 'Semiconductores' },
            { ticker: 'AMZN', nombre: 'Amazon.com Inc.', sector: 'E-commerce' },
            { ticker: 'GOOGL', nombre: 'Alphabet Inc. Class A', sector: 'Tecnolog√≠a' },
            { ticker: 'META', nombre: 'Meta Platforms Inc.', sector: 'Tecnolog√≠a' },
            { ticker: 'GOOG', nombre: 'Alphabet Inc. Class C', sector: 'Tecnolog√≠a' },
            { ticker: 'BRK.B', nombre: 'Berkshire Hathaway B', sector: 'Finanzas' },
            { ticker: 'LLY', nombre: 'Eli Lilly & Company', sector: 'Farmac√©utica' },
            { ticker: 'TSLA', nombre: 'Tesla Inc.', sector: 'Automotriz' },
            { ticker: 'UNH', nombre: 'UnitedHealth Group', sector: 'Salud' },
            { ticker: 'JPM', nombre: 'JPMorgan Chase & Co.', sector: 'Finanzas' },
            { ticker: 'V', nombre: 'Visa Inc.', sector: 'Finanzas' },
            { ticker: 'XOM', nombre: 'Exxon Mobil Corporation', sector: 'Energ√≠a' },
            { ticker: 'AVGO', nombre: 'Broadcom Inc.', sector: 'Semiconductores' },
            { ticker: 'MA', nombre: 'Mastercard Inc.', sector: 'Finanzas' },
            { ticker: 'JNJ', nombre: 'Johnson & Johnson', sector: 'Salud' },
            { ticker: 'PG', nombre: 'Procter & Gamble Co.', sector: 'Consumo' },
            { ticker: 'HD', nombre: 'Home Depot Inc.', sector: 'Retail' },
            { ticker: 'COST', nombre: 'Costco Wholesale Corp.', sector: 'Retail' },
            { ticker: 'MRK', nombre: 'Merck & Co. Inc.', sector: 'Farmac√©utica' },
            { ticker: 'ABBV', nombre: 'AbbVie Inc.', sector: 'Farmac√©utica' },
            { ticker: 'CVX', nombre: 'Chevron Corporation', sector: 'Energ√≠a' },
            { ticker: 'CRM', nombre: 'Salesforce Inc.', sector: 'Software' },
            { ticker: 'NFLX', nombre: 'Netflix Inc.', sector: 'Entretenimiento' },
            { ticker: 'AMD', nombre: 'Advanced Micro Devices', sector: 'Semiconductores' },
            { ticker: 'KO', nombre: 'Coca-Cola Company', sector: 'Bebidas' },
            { ticker: 'PEP', nombre: 'PepsiCo Inc.', sector: 'Bebidas' },
            { ticker: 'BAC', nombre: 'Bank of America Corp.', sector: 'Finanzas' },
            { ticker: 'WMT', nombre: 'Walmart Inc.', sector: 'Retail' }
        ];

        const INDICES_DATA = {
            dow: {
                nombre: 'DOW JONES',
                total: 30,
                empresas: DOW_COMPONENTS.map(e => ({ ...e, price: 0, change: 0, changePercent: 0, weight: 0 }))
            },
            nasdaq: {
                nombre: 'NASDAQ 100',
                total: 100,
                empresas: NASDAQ_COMPONENTS.map(e => ({ ...e, price: 0, change: 0, changePercent: 0, weight: 0 }))
            },
            sp500: {
                nombre: 'S&P 500',
                total: 500,
                empresas: SP500_COMPONENTS.map(e => ({ ...e, price: 0, change: 0, changePercent: 0, weight: 0 }))
            }
        };

        // Variables globales
        let preciosEnTiempoReal = {};
        let datosHistoricos = {};
        let currentView = 'home';
        let currentFilter = 'all';
        let expandedSections = { dow: false, nasdaq: false, sp500: false };
        
        // Reels state
        let reelsState = {
            currentIndexKey: 'nasdaq',
            currentAssetIndex: { watchlist: 0, dow: 0, nasdaq: 0, sp500: 0 },
            charts: {},
            touchStartX: 0,
            touchStartY: 0,
            touchEndX: 0,
            touchEndY: 0,
            isSwiping: false
        };
        
        const INDEX_ORDER = ['watchlist', 'dow', 'nasdaq', 'sp500'];

        // ==========================================
        // NAVEGACI√ìN
        // ==========================================
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${viewId}`).classList.add('active');
            
            currentView = viewId;
            
            if (viewId === 'chart') {
                initReels();
            }
            
            if (viewId === 'community') {
                renderCommunity();
            }
        }

        function filterTab(filter, btn) {
            currentFilter = filter;
            expandedSections = { dow: false, nasdaq: false, sp500: false };
            document.querySelectorAll('.tabs-container .tab-btn:not(.tab-watchlist)').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderHomeContent();
        }

        // ==========================================
        // REELS SYSTEM - CON CAROUSEL INFINITO
        // ==========================================
        function initReels() {
            buildReelCards();
            updateReelsPosition();
            setupSwipeListeners();
            loadCurrentReelChart();
        }
        
        function buildReelCards() {
            buildWatchlistCards();
            
            ['dow', 'nasdaq', 'sp500'].forEach(indexKey => {
                const container = document.getElementById(`reels-vertical-${indexKey}`);
                const empresas = INDICES_DATA[indexKey].empresas;
                container.innerHTML = empresas.map((empresa, i) => buildReelCardHTML(empresa, indexKey, i)).join('');
            });
        }
        
        function buildWatchlistCards() {
            const container = document.getElementById('reels-vertical-watchlist');
            const empresas = getWatchlistEmpresas();
            
            if (empresas.length === 0) {
                container.innerHTML = `
                    <div class="reel-card">
                        <div class="empty-watchlist">
                            <div class="empty-watchlist-icon">‚≠ê</div>
                            <div class="empty-watchlist-title">Tu Watch List est√° vac√≠a</div>
                            <div class="empty-watchlist-text">
                                Agrega activos tocando la estrella ‚òÜ<br>
                                en cualquier activo de los √≠ndices
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = empresas.map((empresa, i) => buildReelCardHTML(empresa, 'watchlist', i)).join('');
        }
        
        function buildReelCardHTML(empresa, indexKey, i) {
            const isPositive = empresa.change >= 0;
            const colorClass = empresa.change === 0 ? 'neutral' : (isPositive ? 'up' : 'down');
            const sign = isPositive && empresa.change !== 0 ? '+' : '';
            const isFav = isFavorite(empresa.ticker);
            
            const badges = [];
            if (INDICES_DATA.dow.empresas.some(e => e.ticker === empresa.ticker)) badges.push({ name: 'DOW', color: '#f7931a' });
            if (INDICES_DATA.nasdaq.empresas.some(e => e.ticker === empresa.ticker)) badges.push({ name: 'NDX', color: '#00d4ff' });
            if (INDICES_DATA.sp500.empresas.some(e => e.ticker === empresa.ticker)) badges.push({ name: 'SPX', color: '#26a69a' });
            
            return `
                <div class="reel-card" data-ticker="${empresa.ticker}" data-index="${indexKey}" data-position="${i}">
                    <div class="reel-header">
                        <div class="reel-top-row">
                            <div class="reel-ticker-info">
                                <div class="reel-ticker">${empresa.ticker}</div>
                                <div class="reel-name">${empresa.nombre}</div>
                            </div>
                            <button class="reel-favorite-btn ${isFav ? 'active' : ''}" data-ticker="${empresa.ticker}" onclick="toggleFavorite('${empresa.ticker}', event)">
                                ${isFav ? '‚≠ê' : '‚òÜ'}
                            </button>
                        </div>
                        <div class="reel-price ${colorClass}">$${formatPrice(empresa.price)}</div>
                        <div class="reel-change-row">
                            <span class="${colorClass}">${sign}${empresa.change.toFixed(2)}</span>
                            <span class="${colorClass}">(${sign}${empresa.changePercent.toFixed(2)}%)</span>
                        </div>
                        <div class="reel-badges">
                            ${badges.map(b => `<span class="reel-badge" style="background:${b.color}22;color:${b.color};border:1px solid ${b.color}44;">${b.name}</span>`).join('')}
                        </div>
                    </div>
                    <div class="reel-chart" id="chart-${indexKey}-${i}"></div>
                    <div class="reel-chat">
                        <div class="chat-header">
                            <span>üí¨ ${empresa.ticker}</span>
                            <span>${Math.floor(Math.random() * 300) + 50} online</span>
                        </div>
                        <div class="chat-messages" id="chat-${indexKey}-${i}">
                            <div class="chat-message">
                                <span class="chat-message-user">Sistema:</span>
                                <span class="chat-message-text">Chat de ${empresa.ticker}</span>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" placeholder="Mensaje..." onkeypress="if(event.key==='Enter')sendReelChat('${indexKey}',${i},this)">
                            <button class="chat-send-btn" onclick="sendReelChat('${indexKey}',${i},this.previousElementSibling)">
                                <svg width="14" height="14" fill="white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateReelsPosition() {
            const horizontalContainer = document.getElementById('reels-horizontal');
            const currentIndexPos = INDEX_ORDER.indexOf(reelsState.currentIndexKey);
            horizontalContainer.style.transform = `translateX(-${currentIndexPos * 100}%)`;
            
            INDEX_ORDER.forEach(indexKey => {
                const verticalContainer = document.getElementById(`reels-vertical-${indexKey}`);
                if (!verticalContainer) return;
                const assetIndex = reelsState.currentAssetIndex[indexKey];
                const containerHeight = document.querySelector('.reels-container').offsetHeight;
                verticalContainer.style.transform = `translateY(-${assetIndex * containerHeight}px)`;
            });
            
            document.querySelectorAll('.reels-index-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.index === reelsState.currentIndexKey);
            });
            
            // Update counter
            let total, currentIdx;
            if (reelsState.currentIndexKey === 'watchlist') {
                const watchlistEmpresas = getWatchlistEmpresas();
                total = watchlistEmpresas.length || 0;
                currentIdx = reelsState.currentAssetIndex.watchlist;
            } else {
                total = INDICES_DATA[reelsState.currentIndexKey].empresas.length;
                currentIdx = reelsState.currentAssetIndex[reelsState.currentIndexKey];
            }
            
            document.getElementById('reels-counter').textContent = total > 0 ? `${currentIdx + 1} / ${total}` : '0 / 0';
        }
        
        function setupSwipeListeners() {
            const container = document.getElementById('reels-container');
            
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);
            
            newContainer.addEventListener('touchstart', (e) => {
                reelsState.touchStartX = e.touches[0].clientX;
                reelsState.touchStartY = e.touches[0].clientY;
                reelsState.isSwiping = true;
            }, { passive: true });
            
            newContainer.addEventListener('touchmove', (e) => {
                if (!reelsState.isSwiping) return;
                reelsState.touchEndX = e.touches[0].clientX;
                reelsState.touchEndY = e.touches[0].clientY;
            }, { passive: true });
            
            newContainer.addEventListener('touchend', () => {
                if (!reelsState.isSwiping) return;
                handleSwipe();
                reelsState.isSwiping = false;
            });
            
            newContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                    if (e.deltaY > 0) navigateReel('down');
                    else navigateReel('up');
                } else {
                    if (e.deltaX > 0) navigateReel('right');
                    else navigateReel('left');
                }
            }, { passive: false });
        }
        
        function handleSwipe() {
            const deltaX = reelsState.touchEndX - reelsState.touchStartX;
            const deltaY = reelsState.touchEndY - reelsState.touchStartY;
            const minSwipeDistance = 50;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) navigateReel('left');
                    else navigateReel('right');
                }
            } else {
                if (Math.abs(deltaY) > minSwipeDistance) {
                    if (deltaY > 0) navigateReel('up');
                    else navigateReel('down');
                }
            }
        }
        
        // CAROUSEL INFINITO
        function navigateReel(direction) {
            const currentIndexKey = reelsState.currentIndexKey;
            const currentPos = INDEX_ORDER.indexOf(currentIndexKey);
            
            let empresasLength;
            if (currentIndexKey === 'watchlist') {
                empresasLength = getWatchlistEmpresas().length;
            } else {
                empresasLength = INDICES_DATA[currentIndexKey].empresas.length;
            }
            
            // Si no hay empresas, no hacer nada
            if (empresasLength === 0 && (direction === 'up' || direction === 'down')) {
                return;
            }
            
            const currentAsset = reelsState.currentAssetIndex[currentIndexKey];
            
            switch(direction) {
                case 'up':
                    // LOOP: Si estamos en el primero, ir al √∫ltimo
                    if (currentAsset > 0) {
                        reelsState.currentAssetIndex[currentIndexKey]--;
                    } else {
                        reelsState.currentAssetIndex[currentIndexKey] = empresasLength - 1;
                    }
                    break;
                case 'down':
                    // LOOP: Si estamos en el √∫ltimo, ir al primero
                    if (currentAsset < empresasLength - 1) {
                        reelsState.currentAssetIndex[currentIndexKey]++;
                    } else {
                        reelsState.currentAssetIndex[currentIndexKey] = 0;
                    }
                    break;
                case 'left':
                    // LOOP horizontal: Si estamos en el primero, ir al √∫ltimo
                    if (currentPos > 0) {
                        reelsState.currentIndexKey = INDEX_ORDER[currentPos - 1];
                    } else {
                        reelsState.currentIndexKey = INDEX_ORDER[INDEX_ORDER.length - 1];
                    }
                    break;
                case 'right':
                    // LOOP horizontal: Si estamos en el √∫ltimo, ir al primero
                    if (currentPos < INDEX_ORDER.length - 1) {
                        reelsState.currentIndexKey = INDEX_ORDER[currentPos + 1];
                    } else {
                        reelsState.currentIndexKey = INDEX_ORDER[0];
                    }
                    break;
            }
            
            // Rebuild watchlist si cambiamos a ella
            if (reelsState.currentIndexKey === 'watchlist') {
                buildWatchlistCards();
            }
            
            updateReelsPosition();
            loadCurrentReelChart();
        }
        
        function switchReelIndex(indexKey) {
            reelsState.currentIndexKey = indexKey;
            if (indexKey === 'watchlist') {
                buildWatchlistCards();
            }
            updateReelsPosition();
            loadCurrentReelChart();
        }
        
        async function loadCurrentReelChart() {
            const indexKey = reelsState.currentIndexKey;
            const assetIndex = reelsState.currentAssetIndex[indexKey];
            
            let empresa;
            if (indexKey === 'watchlist') {
                const empresas = getWatchlistEmpresas();
                if (empresas.length === 0) return;
                empresa = empresas[assetIndex];
            } else {
                empresa = INDICES_DATA[indexKey].empresas[assetIndex];
            }
            
            if (!empresa) return;
            
            const chartId = `chart-${indexKey}-${assetIndex}`;
            const container = document.getElementById(chartId);
            
            if (!container || reelsState.charts[chartId]) return;
            
            const chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#131722' }, textColor: '#787b86' },
                grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
                timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2a2e39' },
                rightPriceScale: { borderColor: '#2a2e39' },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
            });
            
            const candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350'
            });
            
            reelsState.charts[chartId] = { chart, candleSeries };
            
            const ticker = empresa.ticker;
            if (ticker.includes('.')) return;
            
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 5);
            
            try {
                const response = await fetch(`https://api.polygon.io/v2/aggs/ticker/${ticker}/range/5/minute/${startDate.toISOString().split('T')[0]}/${endDate.toISOString().split('T')[0]}?adjusted=true&sort=asc&limit=2000&apiKey=${API_KEY}`);
                const data = await response.json();
                
                if (data.results?.length > 0) {
                    candleSeries.setData(data.results.map(bar => ({
                        time: bar.t / 1000,
                        open: bar.o,
                        high: bar.h,
                        low: bar.l,
                        close: bar.c
                    })));
                    chart.timeScale().fitContent();
                }
            } catch (error) {
                console.error('Error:', error);
            }
            
            new ResizeObserver(() => {
                chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
            }).observe(container);
        }
        
        function sendReelChat(indexKey, assetIndex, input) {
            const message = input.value.trim();
            if (!message) return;
            
            const chatContainer = document.getElementById(`chat-${indexKey}-${assetIndex}`);
            if (!chatContainer) return;
            
            chatContainer.insertAdjacentHTML('beforeend', `
                <div class="chat-message">
                    <span class="chat-message-user">T√∫:</span>
                    <span class="chat-message-text">${message}</span>
                </div>
            `);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            input.value = '';
            
            setTimeout(() => {
                const responses = ['Buen an√°lisis! üìä', 'De acuerdo üëç', 'Interesante', 'Gracias!'];
                const users = ['Trader1', 'ProInvestor', 'StockGuru'];
                chatContainer.insertAdjacentHTML('beforeend', `
                    <div class="chat-message">
                        <span class="chat-message-user">${users[Math.floor(Math.random() * users.length)]}:</span>
                        <span class="chat-message-text">${responses[Math.floor(Math.random() * responses.length)]}</span>
                    </div>
                `);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1000 + Math.random() * 1500);
        }
        
        function selectAsset(ticker, indiceKey) {
            const empresas = INDICES_DATA[indiceKey].empresas;
            const assetIndex = empresas.findIndex(e => e.ticker === ticker);
            
            if (assetIndex !== -1) {
                reelsState.currentIndexKey = indiceKey;
                reelsState.currentAssetIndex[indiceKey] = assetIndex;
                switchView('chart');
            }
        }

        // ==========================================
        // DATA LOADING
        // ==========================================
        async function cargarDatosIniciales() {
            updateStatus('loading', 'Cargando...');
            
            const allTickers = new Set();
            Object.values(INDICES_DATA).forEach(indice => {
                indice.empresas.forEach(e => {
                    if (!e.ticker.includes('.')) allTickers.add(e.ticker);
                });
            });
            
            const tickersArray = Array.from(allTickers);
            const batchSize = 50;
            
            for (let i = 0; i < tickersArray.length; i += batchSize) {
                const batch = tickersArray.slice(i, i + batchSize).join(',');
                
                try {
                    const response = await fetch(`https://api.polygon.io/v2/snapshot/locale/us/markets/stocks/tickers?tickers=${batch}&apiKey=${API_KEY}`);
                    const data = await response.json();
                    
                    if (data.tickers) {
                        data.tickers.forEach(t => {
                            const price = t.day?.c || t.prevDay?.c || 0;
                            const prevClose = t.prevDay?.c || price;
                            preciosEnTiempoReal[t.ticker] = price;
                            datosHistoricos[t.ticker] = {
                                previousClose: prevClose,
                                change: price - prevClose,
                                changePercent: prevClose > 0 ? ((price - prevClose) / prevClose) * 100 : 0
                            };
                        });
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
                
                if (i + batchSize < tickersArray.length) {
                    await new Promise(r => setTimeout(r, 50));
                }
            }
            
            actualizarDatosEmpresas();
            calcularPesos();
            renderHomeContent();
            updateStatus('live', 'LIVE');
        }

        function actualizarDatosEmpresas() {
            Object.values(INDICES_DATA).forEach(indice => {
                indice.empresas.forEach(empresa => {
                    const precio = preciosEnTiempoReal[empresa.ticker];
                    const hist = datosHistoricos[empresa.ticker];
                    if (precio) empresa.price = precio;
                    if (hist) {
                        empresa.change = hist.change;
                        empresa.changePercent = hist.changePercent;
                    }
                });
            });
        }

        function calcularPesos() {
            const dowEmpresas = INDICES_DATA.dow.empresas;
            const totalPrecio = dowEmpresas.reduce((sum, e) => sum + (e.price || 0), 0);
            if (totalPrecio > 0) {
                dowEmpresas.forEach(e => e.weight = ((e.price || 0) / totalPrecio) * 100);
            }
            dowEmpresas.sort((a, b) => b.weight - a.weight);
            
            ['nasdaq', 'sp500'].forEach(key => {
                const empresas = INDICES_DATA[key].empresas;
                let totalWeight = 0;
                empresas.forEach((e, i) => {
                    e.weight = Math.pow(0.92, i) * 10;
                    totalWeight += e.weight;
                });
                empresas.forEach(e => e.weight = (e.weight / totalWeight) * 100);
            });
        }

        // ==========================================
        // WEBSOCKET
        // ==========================================
        function conectarWebSocket() {
            socket = new WebSocket('wss://socket.polygon.io/stocks');
            
            socket.onopen = () => {
                socket.send(JSON.stringify({ action: 'auth', params: API_KEY }));
            };
            
            socket.onmessage = (event) => {
                const latency = Date.now() - lastMessageTime;
                lastMessageTime = Date.now();
                document.getElementById('latency-display').textContent = `${Math.min(latency, 999)}ms`;
                
                JSON.parse(event.data).forEach(msg => {
                    if (msg.ev === 'status' && msg.status === 'auth_success') {
                        updateStatus('live', 'LIVE');
                        document.getElementById('ws-status').textContent = 'üü¢ Conectado';
                        document.getElementById('ws-status').style.color = '#26a69a';
                        suscribirTickers();
                    }
                    if (msg.ev === 'T') procesarTrade(msg);
                });
            };
            
            socket.onerror = () => {
                updateStatus('offline', 'ERROR');
                document.getElementById('ws-status').textContent = 'üî¥ Error';
            };
            
            socket.onclose = () => {
                updateStatus('offline', 'OFFLINE');
                document.getElementById('ws-status').textContent = 'üî¥ Desconectado';
                if (reconnectAttempts < 5) {
                    reconnectAttempts++;
                    setTimeout(conectarWebSocket, 2000 * reconnectAttempts);
                }
            };
        }

        function suscribirTickers() {
            const allTickers = new Set();
            Object.values(INDICES_DATA).forEach(indice => {
                indice.empresas.forEach(e => {
                    if (!e.ticker.includes('.')) allTickers.add(e.ticker);
                });
            });
            socket.send(JSON.stringify({ action: 'subscribe', params: Array.from(allTickers).map(t => `T.${t}`).join(',') }));
        }

        function procesarTrade(msg) {
            const ticker = msg.sym;
            const price = msg.p;
            
            preciosEnTiempoReal[ticker] = price;
            
            const hist = datosHistoricos[ticker];
            if (hist) {
                hist.change = price - hist.previousClose;
                hist.changePercent = hist.previousClose > 0 ? ((price - hist.previousClose) / hist.previousClose) * 100 : 0;
            }
            
            Object.values(INDICES_DATA).forEach(indice => {
                const empresa = indice.empresas.find(e => e.ticker === ticker);
                if (empresa) {
                    empresa.price = price;
                    if (hist) {
                        empresa.change = hist.change;
                        empresa.changePercent = hist.changePercent;
                    }
                }
            });
            
            clearTimeout(window.renderTimeout);
            window.renderTimeout = setTimeout(() => {
                calcularPesos();
                renderHomeContent();
            }, 300);
        }

        function updateStatus(status, text) {
            document.getElementById('status-dot').className = 'status-dot ' + (status === 'live' ? 'status-live' : 'status-offline');
            document.getElementById('status-text').textContent = text;
            document.getElementById('status-text').style.color = status === 'live' ? '#26a69a' : '#ef5350';
        }

        // ==========================================
        // RENDER HOME
        // ==========================================
        function renderHomeContent() {
            const container = document.getElementById('home-content');
            let html = '';
            
            const indices = currentFilter === 'all' ? ['dow', 'nasdaq', 'sp500'] : [currentFilter];
            
            indices.forEach(key => {
                const indice = INDICES_DATA[key];
                const empresas = indice.empresas;
                const isExpanded = expandedSections[key];
                const showCount = isExpanded ? empresas.length : 10;
                const visibleEmpresas = empresas.slice(0, showCount);
                
                html += `<div class="section-header"><span>${indice.nombre}</span><span class="section-count">${isExpanded ? empresas.length : '10'} / ${indice.total}</span></div>`;
                
                visibleEmpresas.forEach((empresa, index) => {
                    html += renderAssetItem(empresa, key, index + 1);
                });
                
                if (empresas.length > 10) {
                    html += `<div class="ver-mas-btn" onclick="toggleSection('${key}')">${isExpanded ? '‚ñ≤ Ver menos' : `‚ñº Ver m√°s (+${empresas.length - 10})`}</div>`;
                }
            });
            
            container.innerHTML = html;
            updateWatchlistCounts();
        }

        function renderAssetItem(empresa, indiceKey, rank) {
            const isPositive = empresa.change >= 0;
            const colorClass = empresa.change === 0 ? 'neutral' : (isPositive ? 'up' : 'down');
            const sign = isPositive && empresa.change !== 0 ? '+' : '';
            const isFav = isFavorite(empresa.ticker);
            
            return `
                <div class="asset-item">
                    <div class="asset-rank">#${rank}</div>
                    <div class="asset-logo" onclick="selectAsset('${empresa.ticker}', '${indiceKey}')">${getLogoHTML(empresa.ticker)}</div>
                    <div class="asset-info" onclick="selectAsset('${empresa.ticker}', '${indiceKey}')">
                        <div class="asset-ticker">${empresa.ticker}</div>
                        <div class="asset-name">${empresa.nombre}</div>
                    </div>
                    <div class="asset-data" onclick="selectAsset('${empresa.ticker}', '${indiceKey}')">
                        <div class="asset-price">${formatPrice(empresa.price)}</div>
                        <div class="asset-change">
                            <span class="${colorClass}">${sign}${empresa.change.toFixed(2)}</span>
                            <span class="${colorClass}">${sign}${empresa.changePercent.toFixed(2)}%</span>
                        </div>
                    </div>
                    <button class="favorite-btn ${isFav ? 'active' : ''}" data-ticker="${empresa.ticker}" onclick="toggleFavorite('${empresa.ticker}', event)">
                        ${isFav ? '‚≠ê' : '‚òÜ'}
                    </button>
                </div>
            `;
        }

        function toggleSection(key) {
            expandedSections[key] = !expandedSections[key];
            renderHomeContent();
        }

        function getLogoHTML(ticker) {
            const colors = {
                'AAPL': '#A2AAAD', 'MSFT': '#00A4EF', 'GOOGL': '#4285F4', 'AMZN': '#FF9900',
                'META': '#1877F2', 'NVDA': '#76B900', 'TSLA': '#CC0000', 'JPM': '#0A3D6E',
                'V': '#1A1F71', 'HD': '#F96302', 'WMT': '#0071CE', 'KO': '#F40009',
                'NKE': '#000000', 'DIS': '#113CCF', 'NFLX': '#E50914', 'GS': '#6BA4D5'
            };
            const bg = colors[ticker] || '#2a2e39';
            return `<div style="width:100%;height:100%;background:${bg};display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:10px;font-weight:700;color:white;">${ticker.substring(0,2)}</div>`;
        }

        function formatPrice(price) {
            if (!price) return '--';
            return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ==========================================
        // SEARCH - CON ESTRELLA FUNCIONANDO
        // ==========================================
        function handleSearch(query) {
            const container = document.getElementById('search-results');
            if (!query) {
                container.innerHTML = '<div class="p-4 text-center text-[#787b86]">Busca cualquier activo</div>';
                return;
            }
            
            const results = [];
            const q = query.toLowerCase();
            Object.entries(INDICES_DATA).forEach(([key, indice]) => {
                indice.empresas.forEach((empresa, i) => {
                    if ((empresa.ticker.toLowerCase().includes(q) || empresa.nombre.toLowerCase().includes(q)) && !results.find(r => r.ticker === empresa.ticker)) {
                        results.push({ ...empresa, indice: key, rank: i + 1 });
                    }
                });
            });
            
            if (results.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-[#787b86]">Sin resultados</div>';
                return;
            }
            
            container.innerHTML = results.slice(0, 20).map(e => renderAssetItem(e, e.indice, e.rank)).join('');
        }

        // ==========================================
        // COMMUNITY
        // ==========================================
        function renderCommunity() {
            const posts = [
                { user: 'TraderPro', avatar: 'TP', time: 'hace 5 min', content: 'üöÄ NVDA rompiendo m√°ximos! Long desde $140.' },
                { user: 'MarketWatch', avatar: 'MW', time: 'hace 12 min', content: 'SPX en resistencia. Ojo con 5850.' },
                { user: 'TechAnalyst', avatar: 'TA', time: 'hace 28 min', content: 'AAPL divergencia bajista en 4H.' }
            ];
            document.getElementById('community-content').innerHTML = posts.map(p => `
                <div class="community-post">
                    <div class="post-header">
                        <div class="post-avatar">${p.avatar}</div>
                        <div><div class="post-user">${p.user}</div><div class="post-time">${p.time}</div></div>
                    </div>
                    <div class="post-content">${p.content}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // MARKET STATUS
        // ==========================================
        function updateMarketStatus() {
            const now = new Date();
            const nyTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            document.getElementById('ny-time').textContent = nyTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            
            const hour = nyTime.getHours();
            const day = nyTime.getDay();
            let status = 'üî¥ Cerrado';
            if (day !== 0 && day !== 6) {
                const mins = hour * 60 + nyTime.getMinutes();
                if (mins >= 240 && mins < 570) status = 'üü° Pre-Market';
                else if (mins >= 570 && mins < 960) status = 'üü¢ Abierto';
                else if (mins >= 960 && mins < 1200) status = 'üîµ After Hours';
            }
            document.getElementById('market-status').textContent = status;
        }

        // ==========================================
        // INIT
        // ==========================================
        window.onload = async () => {
            updateWatchlistCounts();
            updateMarketStatus();
            setInterval(updateMarketStatus, 30000);
            await cargarDatosIniciales();
            conectarWebSocket();
        };
        
        window.onbeforeunload = () => { if (socket) socket.close(); };
    </script>
</body>
</html>